{"dependencies":[],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"ReduceProgram\", {\n    enumerable: true,\n    get: function () {\n      return ReduceProgram;\n    }\n  });\n  /**\n   * @license\n   * Copyright 2017 Google LLC. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n  class ReduceProgram {\n    constructor(reduceInfo, reduceType) {\n      this.variableNames = ['x'];\n      const {\n        windowSize,\n        batchSize,\n        inSize,\n        outSize\n      } = reduceInfo;\n      this.outputShape = [batchSize, outSize];\n      let initializationValue = '0.0';\n      let compareOp = ``;\n      if (reduceType === 'prod') {\n        initializationValue = '1.0';\n      } else if (reduceType === 'min') {\n        // WebGL on Firefox Linux can't compile 1/0 so we do 1/eps.\n        initializationValue = '1.0 / 1e-20';\n        compareOp = `min`;\n      } else if (reduceType === 'max') {\n        // WebGL on Firefox Linux can't compile 1/0 so we do 1/eps.\n        initializationValue = '-1.0 / 1e-20';\n        compareOp = `max`;\n      }\n      let returnValue = `${reduceType}(${reduceType}(${reduceType}(` + 'minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])';\n      if (reduceType === 'sum') {\n        returnValue = `sumValue`;\n      } else if (reduceType === 'prod') {\n        returnValue = `prodValue`;\n      } else if (reduceType === 'all') {\n        returnValue = `allValue`;\n      } else if (reduceType === 'any') {\n        returnValue = `anyValue`;\n      }\n      const windowSizeNearestVec4 = Math.floor(windowSize / 4) * 4;\n      const windowSizeVec4Remainder = windowSize % 4;\n      let updateSnippet = `\n      if (${reduceType === 'sum'}) {\n        sumValue += dot(values, ones);\n      } else if (${reduceType === 'prod'}) {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = ${compareOp}(values, minMaxValue);\n        if (${reduceType === 'min'} || ${reduceType === 'max'}) {\n          minMaxValue = ${compareOp}(values, minMaxValue);\n          bvec4 isNaN = isnan(values);\n          if (isNaN.r || isNaN.g || isNaN.b || isNaN.a) {\n            minMaxValue = vec4(NAN);\n          }\n        }\n      }\n    `;\n      let vecType = `vec4`;\n      if (reduceType === 'all') {\n        initializationValue = '1.0';\n        updateSnippet = `\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      `;\n        vecType = `bvec4`;\n      } else if (reduceType === 'any') {\n        initializationValue = '0.0';\n        updateSnippet = `\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      `;\n        vecType = `bvec4`;\n      }\n      let checkOutOfBounds = '';\n      if (inSize % windowSize > 0) {\n        checkOutOfBounds = `\n        if (inIdx < 0 || inIdx >= ${inSize}) {\n          return initializationValue;\n        }\n      `;\n      }\n      this.userCode = `\n      const float initializationValue = ${initializationValue};\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        ${checkOutOfBounds}\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * ${windowSize};\n\n        vec4 minMaxValue = vec4(${initializationValue});\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < ${windowSizeNearestVec4}; i += 4) {\n          int inIdx = inOffset + i;\n          ${vecType} values = ${vecType}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          ${updateSnippet}\n        }\n\n        int inIdx = inOffset + ${windowSizeNearestVec4};\n        if (${windowSizeVec4Remainder === 1}) {\n          ${vecType} values = ${vecType}(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          ${updateSnippet}\n        } else if (${windowSizeVec4Remainder === 2}) {\n          ${vecType} values = ${vecType}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          ${updateSnippet}\n        } else if (${windowSizeVec4Remainder === 3}) {\n          ${vecType} values = ${vecType}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          ${updateSnippet}\n        }\n        setOutput(${returnValue});\n      }\n    `;\n    }\n  }\n});","lineCount":174,"map":[[7,2,17,0,"Object"],[7,8,17,0],[7,9,17,0,"defineProperty"],[7,23,17,0],[7,24,17,0,"exports"],[7,31,17,0],[8,4,17,0,"enumerable"],[8,14,17,0],[9,4,17,0,"get"],[9,7,17,0],[9,18,17,0,"get"],[9,19,17,0],[10,6,17,0],[10,13,17,0,"ReduceProgram"],[10,26,17,0],[11,4,17,0],[12,2,17,0],[13,2,1,0],[14,0,2,0],[15,0,3,0],[16,0,4,0],[17,0,5,0],[18,0,6,0],[19,0,7,0],[20,0,8,0],[21,0,9,0],[22,0,10,0],[23,0,11,0],[24,0,12,0],[25,0,13,0],[26,0,14,0],[27,0,15,0],[28,0,16,0],[29,2,17,7],[29,8,17,13,"ReduceProgram"],[29,21,17,26],[29,22,17,27],[30,4,18,4,"constructor"],[30,15,18,15,"constructor"],[30,16,18,16,"reduceInfo"],[30,26,18,26],[30,28,18,28,"reduceType"],[30,38,18,38],[30,40,18,40],[31,6,19,8],[31,10,19,12],[31,11,19,13,"variableNames"],[31,24,19,26],[31,27,19,29],[31,28,19,30],[31,31,19,33],[31,32,19,34],[32,6,20,8],[32,12,20,14],[33,8,20,16,"windowSize"],[33,18,20,26],[34,8,20,28,"batchSize"],[34,17,20,37],[35,8,20,39,"inSize"],[35,14,20,45],[36,8,20,47,"outSize"],[37,6,20,55],[37,7,20,56],[37,10,20,59,"reduceInfo"],[37,20,20,69],[38,6,21,8],[38,10,21,12],[38,11,21,13,"outputShape"],[38,22,21,24],[38,25,21,27],[38,26,21,28,"batchSize"],[38,35,21,37],[38,37,21,39,"outSize"],[38,44,21,46],[38,45,21,47],[39,6,22,8],[39,10,22,12,"initializationValue"],[39,29,22,31],[39,32,22,34],[39,37,22,39],[40,6,23,8],[40,10,23,12,"compareOp"],[40,19,23,21],[40,22,23,24],[40,24,23,26],[41,6,24,8],[41,10,24,12,"reduceType"],[41,20,24,22],[41,25,24,27],[41,31,24,33],[41,33,24,35],[42,8,25,12,"initializationValue"],[42,27,25,31],[42,30,25,34],[42,35,25,39],[43,6,26,8],[43,7,26,9],[43,13,27,13],[43,17,27,17,"reduceType"],[43,27,27,27],[43,32,27,32],[43,37,27,37],[43,39,27,39],[44,8,28,12],[45,8,29,12,"initializationValue"],[45,27,29,31],[45,30,29,34],[45,43,29,47],[46,8,30,12,"compareOp"],[46,17,30,21],[46,20,30,24],[46,25,30,29],[47,6,31,8],[47,7,31,9],[47,13,32,13],[47,17,32,17,"reduceType"],[47,27,32,27],[47,32,32,32],[47,37,32,37],[47,39,32,39],[48,8,33,12],[49,8,34,12,"initializationValue"],[49,27,34,31],[49,30,34,34],[49,44,34,48],[50,8,35,12,"compareOp"],[50,17,35,21],[50,20,35,24],[50,25,35,29],[51,6,36,8],[52,6,37,8],[52,10,37,12,"returnValue"],[52,21,37,23],[52,24,37,26],[52,27,37,29,"reduceType"],[52,37,37,39],[52,41,37,43,"reduceType"],[52,51,37,53],[52,55,37,57,"reduceType"],[52,65,37,67],[52,68,37,70],[52,71,38,12],[52,138,38,79],[53,6,39,8],[53,10,39,12,"reduceType"],[53,20,39,22],[53,25,39,27],[53,30,39,32],[53,32,39,34],[54,8,40,12,"returnValue"],[54,19,40,23],[54,22,40,26],[54,32,40,36],[55,6,41,8],[55,7,41,9],[55,13,42,13],[55,17,42,17,"reduceType"],[55,27,42,27],[55,32,42,32],[55,38,42,38],[55,40,42,40],[56,8,43,12,"returnValue"],[56,19,43,23],[56,22,43,26],[56,33,43,37],[57,6,44,8],[57,7,44,9],[57,13,45,13],[57,17,45,17,"reduceType"],[57,27,45,27],[57,32,45,32],[57,37,45,37],[57,39,45,39],[58,8,46,12,"returnValue"],[58,19,46,23],[58,22,46,26],[58,32,46,36],[59,6,47,8],[59,7,47,9],[59,13,48,13],[59,17,48,17,"reduceType"],[59,27,48,27],[59,32,48,32],[59,37,48,37],[59,39,48,39],[60,8,49,12,"returnValue"],[60,19,49,23],[60,22,49,26],[60,32,49,36],[61,6,50,8],[62,6,51,8],[62,12,51,14,"windowSizeNearestVec4"],[62,33,51,35],[62,36,51,38,"Math"],[62,40,51,42],[62,41,51,43,"floor"],[62,46,51,48],[62,47,51,49,"windowSize"],[62,57,51,59],[62,60,51,62],[62,61,51,63],[62,62,51,64],[62,65,51,67],[62,66,51,68],[63,6,52,8],[63,12,52,14,"windowSizeVec4Remainder"],[63,35,52,37],[63,38,52,40,"windowSize"],[63,48,52,50],[63,51,52,53],[63,52,52,54],[64,6,53,8],[64,10,53,12,"updateSnippet"],[64,23,53,25],[64,26,53,28],[65,0,54,0],[65,12,54,12,"reduceType"],[65,22,54,22],[65,27,54,27],[65,32,54,32],[66,0,55,0],[67,0,56,0],[67,19,56,19,"reduceType"],[67,29,56,29],[67,34,56,34],[67,40,56,40],[68,0,57,0],[69,0,58,0],[70,0,59,0],[71,0,60,0],[71,24,60,24,"compareOp"],[71,33,60,33],[72,0,61,0],[72,14,61,14,"reduceType"],[72,24,61,24],[72,29,61,29],[72,34,61,34],[72,41,61,41,"reduceType"],[72,51,61,51],[72,56,61,56],[72,61,61,61],[73,0,62,0],[73,26,62,26,"compareOp"],[73,35,62,35],[74,0,63,0],[75,0,64,0],[76,0,65,0],[77,0,66,0],[78,0,67,0],[79,0,68,0],[80,0,69,0],[80,5,69,5],[81,6,70,8],[81,10,70,12,"vecType"],[81,17,70,19],[81,20,70,22],[81,26,70,28],[82,6,71,8],[82,10,71,12,"reduceType"],[82,20,71,22],[82,25,71,27],[82,30,71,32],[82,32,71,34],[83,8,72,12,"initializationValue"],[83,27,72,31],[83,30,72,34],[83,35,72,39],[84,8,73,12,"updateSnippet"],[84,21,73,25],[84,24,73,28],[85,0,74,0],[86,0,75,0],[87,0,76,0],[88,0,77,0],[88,7,77,7],[89,8,78,12,"vecType"],[89,15,78,19],[89,18,78,22],[89,25,78,29],[90,6,79,8],[90,7,79,9],[90,13,80,13],[90,17,80,17,"reduceType"],[90,27,80,27],[90,32,80,32],[90,37,80,37],[90,39,80,39],[91,8,81,12,"initializationValue"],[91,27,81,31],[91,30,81,34],[91,35,81,39],[92,8,82,12,"updateSnippet"],[92,21,82,25],[92,24,82,28],[93,0,83,0],[94,0,84,0],[95,0,85,0],[96,0,86,0],[96,7,86,7],[97,8,87,12,"vecType"],[97,15,87,19],[97,18,87,22],[97,25,87,29],[98,6,88,8],[99,6,89,8],[99,10,89,12,"checkOutOfBounds"],[99,26,89,28],[99,29,89,31],[99,31,89,33],[100,6,90,8],[100,10,90,12,"inSize"],[100,16,90,18],[100,19,90,21,"windowSize"],[100,29,90,31],[100,32,90,34],[100,33,90,35],[100,35,90,37],[101,8,91,12,"checkOutOfBounds"],[101,24,91,28],[101,27,91,31],[102,0,92,0],[102,36,92,36,"inSize"],[102,42,92,42],[103,0,93,0],[104,0,94,0],[105,0,95,0],[105,7,95,7],[106,6,96,8],[107,6,97,8],[107,10,97,12],[107,11,97,13,"userCode"],[107,19,97,21],[107,22,97,24],[108,0,98,0],[108,42,98,42,"initializationValue"],[108,61,98,61],[109,0,99,0],[110,0,100,0],[111,0,101,0],[112,0,102,0],[112,10,102,10,"checkOutOfBounds"],[112,26,102,26],[113,0,103,0],[114,0,104,0],[115,0,105,0],[116,0,106,0],[117,0,107,0],[118,0,108,0],[119,0,109,0],[120,0,110,0],[120,34,110,34,"windowSize"],[120,44,110,44],[121,0,111,0],[122,0,112,0],[122,34,112,34,"initializationValue"],[122,53,112,53],[123,0,113,0],[124,0,114,0],[125,0,115,0],[126,0,116,0],[127,0,117,0],[128,0,118,0],[128,30,118,30,"windowSizeNearestVec4"],[128,51,118,51],[129,0,119,0],[130,0,120,0],[130,12,120,12,"vecType"],[130,19,120,19],[130,32,120,32,"vecType"],[130,39,120,39],[131,0,121,0],[132,0,122,0],[133,0,123,0],[134,0,124,0],[135,0,125,0],[136,0,126,0],[137,0,127,0],[137,12,127,12,"updateSnippet"],[137,25,127,25],[138,0,128,0],[139,0,129,0],[140,0,130,0],[140,33,130,33,"windowSizeNearestVec4"],[140,54,130,54],[141,0,131,0],[141,14,131,14,"windowSizeVec4Remainder"],[141,37,131,37],[141,42,131,42],[141,43,131,43],[142,0,132,0],[142,12,132,12,"vecType"],[142,19,132,19],[142,32,132,32,"vecType"],[142,39,132,39],[143,0,133,0],[144,0,134,0],[145,0,135,0],[146,0,136,0],[147,0,137,0],[148,0,138,0],[149,0,139,0],[149,12,139,12,"updateSnippet"],[149,25,139,25],[150,0,140,0],[150,21,140,21,"windowSizeVec4Remainder"],[150,44,140,44],[150,49,140,49],[150,50,140,50],[151,0,141,0],[151,12,141,12,"vecType"],[151,19,141,19],[151,32,141,32,"vecType"],[151,39,141,39],[152,0,142,0],[153,0,143,0],[154,0,144,0],[155,0,145,0],[156,0,146,0],[157,0,147,0],[158,0,148,0],[158,12,148,12,"updateSnippet"],[158,25,148,25],[159,0,149,0],[159,21,149,21,"windowSizeVec4Remainder"],[159,44,149,44],[159,49,149,49],[159,50,149,50],[160,0,150,0],[160,12,150,12,"vecType"],[160,19,150,19],[160,32,150,32,"vecType"],[160,39,150,39],[161,0,151,0],[162,0,152,0],[163,0,153,0],[164,0,154,0],[165,0,155,0],[166,0,156,0],[167,0,157,0],[167,12,157,12,"updateSnippet"],[167,25,157,25],[168,0,158,0],[169,0,159,0],[169,20,159,20,"returnValue"],[169,31,159,31],[170,0,160,0],[171,0,161,0],[171,5,161,5],[172,4,162,4],[173,2,163,0],[174,0,163,1],[174,3]],"functionMap":{"names":["<global>","ReduceProgram","ReduceProgram#constructor"],"mappings":"AAA;OCgB;ICC;KDgJ;CDC"},"hasCjsExports":false},"type":"js/module"}]}