{"dependencies":[{"name":"./gpgpu_math","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":17,"column":0,"index":703},"end":{"line":17,"column":48,"index":751}}],"key":"r7nFADTf/sGcqNrAYkmj7Z35J80=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"MatMulPackedProgram\", {\n    enumerable: true,\n    get: function () {\n      return MatMulPackedProgram;\n    }\n  });\n  var _gpgpu_math = require(_dependencyMap[0], \"./gpgpu_math\");\n  /**\n   * @license\n   * Copyright 2018 Google LLC. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n\n  class MatMulPackedProgram {\n    constructor(aShape, bShape, outputShape, transposeA = false, transposeB = false, addBias = false, activation = null, hasPreluActivation = false, hasLeakyreluActivation = false) {\n      this.variableNames = ['matrixA', 'matrixB'];\n      this.packedInputs = true;\n      this.packedOutput = true;\n      this.outputShape = outputShape;\n      this.enableShapeUniforms = (0, _gpgpu_math.useShapeUniforms)(this.outputShape.length);\n      const sharedDim = transposeA ? aShape[1] : aShape[2];\n      const sharedDimensionPacked = Math.ceil(sharedDim / 2);\n      const aSample = transposeA ? 'i * 2, rc.y' : 'rc.y, i * 2';\n      const bSample = transposeB ? 'rc.z, i * 2' : 'i * 2, rc.z';\n      const aSwizzle = transposeA ? ['a.xxyy', 'a.zzww'] : ['a.xxzz', 'a.yyww'];\n      const bSwizzle = transposeB ? ['b.xzxz', 'b.ywyw'] : ['b.xyxy', 'b.zwzw'];\n      let activationSnippet = '',\n        applyActivationSnippet = '';\n      if (activation) {\n        if (hasPreluActivation) {\n          activationSnippet = `vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          ${activation}\n        }`;\n        } else if (hasLeakyreluActivation) {\n          activationSnippet = `vec4 activation(vec4 a) {\n          vec4 b = getLeakyreluAlphaAtOutCoords();\n          ${activation}\n        }`;\n        } else {\n          activationSnippet = `vec4 activation(vec4 x) {\n          ${activation}\n        }`;\n        }\n        applyActivationSnippet = `result = activation(result);`;\n      }\n      const addBiasSnippet = addBias ? 'result += getBiasAtOutCoords();' : '';\n      if (addBias) {\n        this.variableNames.push('bias');\n      }\n      if (hasPreluActivation) {\n        this.variableNames.push('preluActivationWeights');\n      }\n      if (hasLeakyreluActivation) {\n        this.variableNames.push('leakyreluAlpha');\n      }\n      let batchASnippet = 'rc.x';\n      let batchBSnippet = 'rc.x';\n      if (aShape[0] < bShape[0]) {\n        batchASnippet = `imod(rc.x, ${aShape[0]})`;\n      } else if (bShape[0] < aShape[0]) {\n        batchBSnippet = `imod(rc.x, ${bShape[0]})`;\n      }\n      this.userCode = `\n      ${activationSnippet}\n      // Don't use uniform for sharedDimensionPacked for performance.\n      const float sharedDimension = ${sharedDimensionPacked}.0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        int batchA = ${batchASnippet};\n        int batchB = ${batchBSnippet};\n        for (int i = 0; i < ${sharedDimensionPacked}; i++) {\n          vec4 a = getMatrixA(batchA, ${aSample});\n          vec4 b = getMatrixB(batchB, ${bSample});\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += (${aSwizzle[0]} * ${bSwizzle[0]});\n          result += (${aSwizzle[1]} * ${bSwizzle[1]});\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        ${addBiasSnippet}\n\n        ${applyActivationSnippet}\n\n        setOutput(result);\n      }\n    `;\n    }\n  }\n});","lineCount":115,"map":[[7,2,18,0,"Object"],[7,8,18,0],[7,9,18,0,"defineProperty"],[7,23,18,0],[7,24,18,0,"exports"],[7,31,18,0],[8,4,18,0,"enumerable"],[8,14,18,0],[9,4,18,0,"get"],[9,7,18,0],[9,18,18,0,"get"],[9,19,18,0],[10,6,18,0],[10,13,18,0,"MatMulPackedProgram"],[10,32,18,0],[11,4,18,0],[12,2,18,0],[13,2,17,0],[13,6,17,0,"_gpgpu_math"],[13,17,17,0],[13,20,17,0,"require"],[13,27,17,0],[13,28,17,0,"_dependencyMap"],[13,42,17,0],[14,2,1,0],[15,0,2,0],[16,0,3,0],[17,0,4,0],[18,0,5,0],[19,0,6,0],[20,0,7,0],[21,0,8,0],[22,0,9,0],[23,0,10,0],[24,0,11,0],[25,0,12,0],[26,0,13,0],[27,0,14,0],[28,0,15,0],[29,0,16,0],[31,2,18,7],[31,8,18,13,"MatMulPackedProgram"],[31,27,18,32],[31,28,18,33],[32,4,19,4,"constructor"],[32,15,19,15,"constructor"],[32,16,19,16,"aShape"],[32,22,19,22],[32,24,19,24,"bShape"],[32,30,19,30],[32,32,19,32,"outputShape"],[32,43,19,43],[32,45,19,45,"transposeA"],[32,55,19,55],[32,58,19,58],[32,63,19,63],[32,65,19,65,"transposeB"],[32,75,19,75],[32,78,19,78],[32,83,19,83],[32,85,19,85,"addBias"],[32,92,19,92],[32,95,19,95],[32,100,19,100],[32,102,19,102,"activation"],[32,112,19,112],[32,115,19,115],[32,119,19,119],[32,121,19,121,"hasPreluActivation"],[32,139,19,139],[32,142,19,142],[32,147,19,147],[32,149,19,149,"hasLeakyreluActivation"],[32,171,19,171],[32,174,19,174],[32,179,19,179],[32,181,19,181],[33,6,20,8],[33,10,20,12],[33,11,20,13,"variableNames"],[33,24,20,26],[33,27,20,29],[33,28,20,30],[33,37,20,39],[33,39,20,41],[33,48,20,50],[33,49,20,51],[34,6,21,8],[34,10,21,12],[34,11,21,13,"packedInputs"],[34,23,21,25],[34,26,21,28],[34,30,21,32],[35,6,22,8],[35,10,22,12],[35,11,22,13,"packedOutput"],[35,23,22,25],[35,26,22,28],[35,30,22,32],[36,6,23,8],[36,10,23,12],[36,11,23,13,"outputShape"],[36,22,23,24],[36,25,23,27,"outputShape"],[36,36,23,38],[37,6,24,8],[37,10,24,12],[37,11,24,13,"enableShapeUniforms"],[37,30,24,32],[37,33,24,35],[37,37,24,35,"useShapeUniforms"],[37,48,24,51],[37,49,24,51,"useShapeUniforms"],[37,65,24,51],[37,67,24,52],[37,71,24,56],[37,72,24,57,"outputShape"],[37,83,24,68],[37,84,24,69,"length"],[37,90,24,75],[37,91,24,76],[38,6,25,8],[38,12,25,14,"sharedDim"],[38,21,25,23],[38,24,25,26,"transposeA"],[38,34,25,36],[38,37,25,39,"aShape"],[38,43,25,45],[38,44,25,46],[38,45,25,47],[38,46,25,48],[38,49,25,51,"aShape"],[38,55,25,57],[38,56,25,58],[38,57,25,59],[38,58,25,60],[39,6,26,8],[39,12,26,14,"sharedDimensionPacked"],[39,33,26,35],[39,36,26,38,"Math"],[39,40,26,42],[39,41,26,43,"ceil"],[39,45,26,47],[39,46,26,48,"sharedDim"],[39,55,26,57],[39,58,26,60],[39,59,26,61],[39,60,26,62],[40,6,27,8],[40,12,27,14,"aSample"],[40,19,27,21],[40,22,27,24,"transposeA"],[40,32,27,34],[40,35,27,37],[40,48,27,50],[40,51,27,53],[40,64,27,66],[41,6,28,8],[41,12,28,14,"bSample"],[41,19,28,21],[41,22,28,24,"transposeB"],[41,32,28,34],[41,35,28,37],[41,48,28,50],[41,51,28,53],[41,64,28,66],[42,6,29,8],[42,12,29,14,"aSwizzle"],[42,20,29,22],[42,23,29,25,"transposeA"],[42,33,29,35],[42,36,29,38],[42,37,29,39],[42,45,29,47],[42,47,29,49],[42,55,29,57],[42,56,29,58],[42,59,29,61],[42,60,29,62],[42,68,29,70],[42,70,29,72],[42,78,29,80],[42,79,29,81],[43,6,30,8],[43,12,30,14,"bSwizzle"],[43,20,30,22],[43,23,30,25,"transposeB"],[43,33,30,35],[43,36,30,38],[43,37,30,39],[43,45,30,47],[43,47,30,49],[43,55,30,57],[43,56,30,58],[43,59,30,61],[43,60,30,62],[43,68,30,70],[43,70,30,72],[43,78,30,80],[43,79,30,81],[44,6,31,8],[44,10,31,12,"activationSnippet"],[44,27,31,29],[44,30,31,32],[44,32,31,34],[45,8,31,36,"applyActivationSnippet"],[45,30,31,58],[45,33,31,61],[45,35,31,63],[46,6,32,8],[46,10,32,12,"activation"],[46,20,32,22],[46,22,32,24],[47,8,33,12],[47,12,33,16,"hasPreluActivation"],[47,30,33,34],[47,32,33,36],[48,10,34,16,"activationSnippet"],[48,27,34,33],[48,30,34,36],[49,0,35,0],[50,0,36,0],[50,12,36,12,"activation"],[50,22,36,22],[51,0,37,0],[51,10,37,10],[52,8,38,12],[52,9,38,13],[52,15,39,17],[52,19,39,21,"hasLeakyreluActivation"],[52,41,39,43],[52,43,39,45],[53,10,40,16,"activationSnippet"],[53,27,40,33],[53,30,40,36],[54,0,41,0],[55,0,42,0],[55,12,42,12,"activation"],[55,22,42,22],[56,0,43,0],[56,10,43,10],[57,8,44,12],[57,9,44,13],[57,15,45,17],[58,10,46,16,"activationSnippet"],[58,27,46,33],[58,30,46,36],[59,0,47,0],[59,12,47,12,"activation"],[59,22,47,22],[60,0,48,0],[60,10,48,10],[61,8,49,12],[62,8,50,12,"applyActivationSnippet"],[62,30,50,34],[62,33,50,37],[62,63,50,67],[63,6,51,8],[64,6,52,8],[64,12,52,14,"addBiasSnippet"],[64,26,52,28],[64,29,52,31,"addBias"],[64,36,52,38],[64,39,52,41],[64,72,52,74],[64,75,52,77],[64,77,52,79],[65,6,53,8],[65,10,53,12,"addBias"],[65,17,53,19],[65,19,53,21],[66,8,54,12],[66,12,54,16],[66,13,54,17,"variableNames"],[66,26,54,30],[66,27,54,31,"push"],[66,31,54,35],[66,32,54,36],[66,38,54,42],[66,39,54,43],[67,6,55,8],[68,6,56,8],[68,10,56,12,"hasPreluActivation"],[68,28,56,30],[68,30,56,32],[69,8,57,12],[69,12,57,16],[69,13,57,17,"variableNames"],[69,26,57,30],[69,27,57,31,"push"],[69,31,57,35],[69,32,57,36],[69,56,57,60],[69,57,57,61],[70,6,58,8],[71,6,59,8],[71,10,59,12,"hasLeakyreluActivation"],[71,32,59,34],[71,34,59,36],[72,8,60,12],[72,12,60,16],[72,13,60,17,"variableNames"],[72,26,60,30],[72,27,60,31,"push"],[72,31,60,35],[72,32,60,36],[72,48,60,52],[72,49,60,53],[73,6,61,8],[74,6,62,8],[74,10,62,12,"batchASnippet"],[74,23,62,25],[74,26,62,28],[74,32,62,34],[75,6,63,8],[75,10,63,12,"batchBSnippet"],[75,23,63,25],[75,26,63,28],[75,32,63,34],[76,6,64,8],[76,10,64,12,"aShape"],[76,16,64,18],[76,17,64,19],[76,18,64,20],[76,19,64,21],[76,22,64,24,"bShape"],[76,28,64,30],[76,29,64,31],[76,30,64,32],[76,31,64,33],[76,33,64,35],[77,8,65,12,"batchASnippet"],[77,21,65,25],[77,24,65,28],[77,38,65,42,"aShape"],[77,44,65,48],[77,45,65,49],[77,46,65,50],[77,47,65,51],[77,50,65,54],[78,6,66,8],[78,7,66,9],[78,13,67,13],[78,17,67,17,"bShape"],[78,23,67,23],[78,24,67,24],[78,25,67,25],[78,26,67,26],[78,29,67,29,"aShape"],[78,35,67,35],[78,36,67,36],[78,37,67,37],[78,38,67,38],[78,40,67,40],[79,8,68,12,"batchBSnippet"],[79,21,68,25],[79,24,68,28],[79,38,68,42,"bShape"],[79,44,68,48],[79,45,68,49],[79,46,68,50],[79,47,68,51],[79,50,68,54],[80,6,69,8],[81,6,70,8],[81,10,70,12],[81,11,70,13,"userCode"],[81,19,70,21],[81,22,70,24],[82,0,71,0],[82,8,71,8,"activationSnippet"],[82,25,71,25],[83,0,72,0],[84,0,73,0],[84,38,73,38,"sharedDimensionPacked"],[84,59,73,59],[85,0,74,0],[86,0,75,0],[87,0,76,0],[88,0,77,0],[88,23,77,23,"batchASnippet"],[88,36,77,36],[89,0,78,0],[89,23,78,23,"batchBSnippet"],[89,36,78,36],[90,0,79,0],[90,30,79,30,"sharedDimensionPacked"],[90,51,79,51],[91,0,80,0],[91,40,80,40,"aSample"],[91,47,80,47],[92,0,81,0],[92,40,81,40,"bSample"],[92,47,81,47],[93,0,82,0],[94,0,83,0],[95,0,84,0],[96,0,85,0],[96,23,85,23,"aSwizzle"],[96,31,85,31],[96,32,85,32],[96,33,85,33],[96,34,85,34],[96,40,85,40,"bSwizzle"],[96,48,85,48],[96,49,85,49],[96,50,85,50],[96,51,85,51],[97,0,86,0],[97,23,86,23,"aSwizzle"],[97,31,86,31],[97,32,86,32],[97,33,86,33],[97,34,86,34],[97,40,86,40,"bSwizzle"],[97,48,86,48],[97,49,86,49],[97,50,86,50],[97,51,86,51],[98,0,87,0],[99,0,88,0],[100,0,89,0],[101,0,90,0],[102,0,91,0],[103,0,92,0],[104,0,93,0],[105,0,94,0],[106,0,95,0],[106,10,95,10,"addBiasSnippet"],[106,24,95,24],[107,0,96,0],[108,0,97,0],[108,10,97,10,"applyActivationSnippet"],[108,32,97,32],[109,0,98,0],[110,0,99,0],[111,0,100,0],[112,0,101,0],[112,5,101,5],[113,4,102,4],[114,2,103,0],[115,0,103,1],[115,3]],"functionMap":{"names":["<global>","MatMulPackedProgram","MatMulPackedProgram#constructor"],"mappings":"AAA;OCiB;ICC;KDmF;CDC"},"hasCjsExports":false},"type":"js/module"}]}