{"dependencies":[{"name":"./glsl_version","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":17,"column":0,"index":703},"end":{"line":17,"column":52,"index":755}}],"key":"PzwIhi74LcKYbosuBjZm+h3PwII=","exportNames":["*"],"imports":1}},{"name":"./gpgpu_math","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":18,"column":0,"index":756},"end":{"line":18,"column":48,"index":804}}],"key":"r7nFADTf/sGcqNrAYkmj7Z35J80=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"Im2ColPackedProgram\", {\n    enumerable: true,\n    get: function () {\n      return Im2ColPackedProgram;\n    }\n  });\n  var _glsl_version = require(_dependencyMap[0], \"./glsl_version\");\n  var _gpgpu_math = require(_dependencyMap[1], \"./gpgpu_math\");\n  /**\n   * @license\n   * Copyright 2019 Google LLC. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n\n  class Im2ColPackedProgram {\n    constructor(outputShape, convInfo) {\n      this.variableNames = ['A'];\n      this.packedInputs = true;\n      this.packedOutput = true;\n      this.customUniforms = [{\n        name: 'inputShape',\n        type: 'ivec4'\n      }, {\n        name: 'pad',\n        type: 'ivec2'\n      }, {\n        name: 'stride',\n        type: 'ivec2'\n      }, {\n        name: 'dilation',\n        type: 'ivec2'\n      }, {\n        name: 'inChannels',\n        type: 'int'\n      }, {\n        name: 'itemsPerBlockRow',\n        type: 'int'\n      }, {\n        name: 'outWidth',\n        type: 'int'\n      }];\n      this.outputShape = outputShape;\n      this.enableShapeUniforms = (0, _gpgpu_math.useShapeUniforms)(this.outputShape.length);\n      const {\n        dataFormat\n      } = convInfo;\n      const glsl = (0, _glsl_version.getGlslDifferences)();\n      const isChannelsLast = dataFormat === 'channelsLast';\n      const rowDim = isChannelsLast ? 1 : 2;\n      const colDim = isChannelsLast ? 2 : 3;\n      const boundsCheckingSnippet = this.enableShapeUniforms ? 'if(blockIndex < outShape[2] && pos < outShape[1]) {' : `if(blockIndex < ${outputShape[2]} && pos < ${outputShape[1]}) {`;\n      let unrolled = ``;\n      for (let row = 0; row <= 1; row++) {\n        for (let col = 0; col <= 1; col++) {\n          unrolled += `\n          blockIndex = rc.z + ${col};\n          pos = rc.y + ${row};\n\n          ${boundsCheckingSnippet}\n            offsetY = int(blockIndex / outWidth) * stride[0] - pad[0];\n            d0 = offsetY + dilation[0] * (pos / itemsPerBlockRow);\n\n            if(d0 < inputShape[${rowDim}] && d0 >= 0) {\n              // Use custom imod instead mod. On Intel GPU, mod may generate\n              // unexpected value.\n              // https://github.com/tensorflow/tfjs/issues/5447\n              offsetX = imod(blockIndex, outWidth) * stride[1] - pad[1];\n              d1 = offsetX + dilation[1] * (imod(pos, itemsPerBlockRow) /\n                  inChannels);\n\n              if(d1 < inputShape[${colDim}] && d1 >= 0) {\n\n                ch = imod(pos, inChannels);\n\n                if (${isChannelsLast}) {\n                  innerDims = vec2(d1, ch);\n                  result[${row * 2 + col}] = getChannel(\n                    getA(rc.x, d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result[${row * 2 + col}] = getChannel(\n                    getA(rc.x, ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        `;\n        }\n      }\n      this.userCode = `\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        ${unrolled}\n\n        ${glsl.output} = result;\n      }\n    `;\n    }\n  }\n});","lineCount":125,"map":[[7,2,19,0,"Object"],[7,8,19,0],[7,9,19,0,"defineProperty"],[7,23,19,0],[7,24,19,0,"exports"],[7,31,19,0],[8,4,19,0,"enumerable"],[8,14,19,0],[9,4,19,0,"get"],[9,7,19,0],[9,18,19,0,"get"],[9,19,19,0],[10,6,19,0],[10,13,19,0,"Im2ColPackedProgram"],[10,32,19,0],[11,4,19,0],[12,2,19,0],[13,2,17,0],[13,6,17,0,"_glsl_version"],[13,19,17,0],[13,22,17,0,"require"],[13,29,17,0],[13,30,17,0,"_dependencyMap"],[13,44,17,0],[14,2,18,0],[14,6,18,0,"_gpgpu_math"],[14,17,18,0],[14,20,18,0,"require"],[14,27,18,0],[14,28,18,0,"_dependencyMap"],[14,42,18,0],[15,2,1,0],[16,0,2,0],[17,0,3,0],[18,0,4,0],[19,0,5,0],[20,0,6,0],[21,0,7,0],[22,0,8,0],[23,0,9,0],[24,0,10,0],[25,0,11,0],[26,0,12,0],[27,0,13,0],[28,0,14,0],[29,0,15,0],[30,0,16,0],[32,2,19,7],[32,8,19,13,"Im2ColPackedProgram"],[32,27,19,32],[32,28,19,33],[33,4,20,4,"constructor"],[33,15,20,15,"constructor"],[33,16,20,16,"outputShape"],[33,27,20,27],[33,29,20,29,"convInfo"],[33,37,20,37],[33,39,20,39],[34,6,21,8],[34,10,21,12],[34,11,21,13,"variableNames"],[34,24,21,26],[34,27,21,29],[34,28,21,30],[34,31,21,33],[34,32,21,34],[35,6,22,8],[35,10,22,12],[35,11,22,13,"packedInputs"],[35,23,22,25],[35,26,22,28],[35,30,22,32],[36,6,23,8],[36,10,23,12],[36,11,23,13,"packedOutput"],[36,23,23,25],[36,26,23,28],[36,30,23,32],[37,6,24,8],[37,10,24,12],[37,11,24,13,"customUniforms"],[37,25,24,27],[37,28,24,30],[37,29,25,12],[38,8,25,14,"name"],[38,12,25,18],[38,14,25,20],[38,26,25,32],[39,8,25,34,"type"],[39,12,25,38],[39,14,25,40],[40,6,25,48],[40,7,25,49],[40,9,26,12],[41,8,26,14,"name"],[41,12,26,18],[41,14,26,20],[41,19,26,25],[42,8,26,27,"type"],[42,12,26,31],[42,14,26,33],[43,6,26,41],[43,7,26,42],[43,9,27,12],[44,8,27,14,"name"],[44,12,27,18],[44,14,27,20],[44,22,27,28],[45,8,27,30,"type"],[45,12,27,34],[45,14,27,36],[46,6,27,44],[46,7,27,45],[46,9,28,12],[47,8,28,14,"name"],[47,12,28,18],[47,14,28,20],[47,24,28,30],[48,8,28,32,"type"],[48,12,28,36],[48,14,28,38],[49,6,28,46],[49,7,28,47],[49,9,29,12],[50,8,29,14,"name"],[50,12,29,18],[50,14,29,20],[50,26,29,32],[51,8,29,34,"type"],[51,12,29,38],[51,14,29,40],[52,6,29,46],[52,7,29,47],[52,9,30,12],[53,8,30,14,"name"],[53,12,30,18],[53,14,30,20],[53,32,30,38],[54,8,30,40,"type"],[54,12,30,44],[54,14,30,46],[55,6,30,52],[55,7,30,53],[55,9,31,12],[56,8,31,14,"name"],[56,12,31,18],[56,14,31,20],[56,24,31,30],[57,8,31,32,"type"],[57,12,31,36],[57,14,31,38],[58,6,31,44],[58,7,31,45],[58,8,32,9],[59,6,33,8],[59,10,33,12],[59,11,33,13,"outputShape"],[59,22,33,24],[59,25,33,27,"outputShape"],[59,36,33,38],[60,6,34,8],[60,10,34,12],[60,11,34,13,"enableShapeUniforms"],[60,30,34,32],[60,33,34,35],[60,37,34,35,"useShapeUniforms"],[60,48,34,51],[60,49,34,51,"useShapeUniforms"],[60,65,34,51],[60,67,34,52],[60,71,34,56],[60,72,34,57,"outputShape"],[60,83,34,68],[60,84,34,69,"length"],[60,90,34,75],[60,91,34,76],[61,6,35,8],[61,12,35,14],[62,8,35,16,"dataFormat"],[63,6,35,27],[63,7,35,28],[63,10,35,31,"convInfo"],[63,18,35,39],[64,6,36,8],[64,12,36,14,"glsl"],[64,16,36,18],[64,19,36,21],[64,23,36,21,"getGlslDifferences"],[64,36,36,39],[64,37,36,39,"getGlslDifferences"],[64,55,36,39],[64,57,36,40],[64,58,36,41],[65,6,37,8],[65,12,37,14,"isChannelsLast"],[65,26,37,28],[65,29,37,31,"dataFormat"],[65,39,37,41],[65,44,37,46],[65,58,37,60],[66,6,38,8],[66,12,38,14,"rowDim"],[66,18,38,20],[66,21,38,23,"isChannelsLast"],[66,35,38,37],[66,38,38,40],[66,39,38,41],[66,42,38,44],[66,43,38,45],[67,6,39,8],[67,12,39,14,"colDim"],[67,18,39,20],[67,21,39,23,"isChannelsLast"],[67,35,39,37],[67,38,39,40],[67,39,39,41],[67,42,39,44],[67,43,39,45],[68,6,40,8],[68,12,40,14,"boundsCheckingSnippet"],[68,33,40,35],[68,36,40,38],[68,40,40,42],[68,41,40,43,"enableShapeUniforms"],[68,60,40,62],[68,63,41,12],[68,116,41,65],[68,119,42,12],[68,138,42,31,"outputShape"],[68,149,42,42],[68,150,42,43],[68,151,42,44],[68,152,42,45],[68,165,42,58,"outputShape"],[68,176,42,69],[68,177,42,70],[68,178,42,71],[68,179,42,72],[68,184,42,77],[69,6,43,8],[69,10,43,12,"unrolled"],[69,18,43,20],[69,21,43,23],[69,23,43,25],[70,6,44,8],[70,11,44,13],[70,15,44,17,"row"],[70,18,44,20],[70,21,44,23],[70,22,44,24],[70,24,44,26,"row"],[70,27,44,29],[70,31,44,33],[70,32,44,34],[70,34,44,36,"row"],[70,37,44,39],[70,39,44,41],[70,41,44,43],[71,8,45,12],[71,13,45,17],[71,17,45,21,"col"],[71,20,45,24],[71,23,45,27],[71,24,45,28],[71,26,45,30,"col"],[71,29,45,33],[71,33,45,37],[71,34,45,38],[71,36,45,40,"col"],[71,39,45,43],[71,41,45,45],[71,43,45,47],[72,10,46,16,"unrolled"],[72,18,46,24],[72,22,46,28],[73,0,47,0],[73,32,47,32,"col"],[73,35,47,35],[74,0,48,0],[74,25,48,25,"row"],[74,28,48,28],[75,0,49,0],[76,0,50,0],[76,12,50,12,"boundsCheckingSnippet"],[76,33,50,33],[77,0,51,0],[78,0,52,0],[79,0,53,0],[80,0,54,0],[80,33,54,33,"rowDim"],[80,39,54,39],[81,0,55,0],[82,0,56,0],[83,0,57,0],[84,0,58,0],[85,0,59,0],[86,0,60,0],[87,0,61,0],[88,0,62,0],[88,35,62,35,"colDim"],[88,41,62,41],[89,0,63,0],[90,0,64,0],[91,0,65,0],[92,0,66,0],[92,22,66,22,"isChannelsLast"],[92,36,66,36],[93,0,67,0],[94,0,68,0],[94,27,68,27,"row"],[94,30,68,30],[94,33,68,33],[94,34,68,34],[94,37,68,37,"col"],[94,40,68,40],[95,0,69,0],[96,0,70,0],[97,0,71,0],[98,0,72,0],[99,0,73,0],[99,27,73,27,"row"],[99,30,73,30],[99,33,73,33],[99,34,73,34],[99,37,73,37,"col"],[99,40,73,40],[100,0,74,0],[101,0,75,0],[102,0,76,0],[103,0,77,0],[104,0,78,0],[105,0,79,0],[106,0,80,0],[106,9,80,9],[107,8,81,12],[108,6,82,8],[109,6,83,8],[109,10,83,12],[109,11,83,13,"userCode"],[109,19,83,21],[109,22,83,24],[110,0,84,0],[111,0,85,0],[112,0,86,0],[113,0,87,0],[114,0,88,0],[115,0,89,0],[116,0,90,0],[117,0,91,0],[118,0,92,0],[118,10,92,10,"unrolled"],[118,18,92,18],[119,0,93,0],[120,0,94,0],[120,10,94,10,"glsl"],[120,14,94,14],[120,15,94,15,"output"],[120,21,94,21],[121,0,95,0],[122,0,96,0],[122,5,96,5],[123,4,97,4],[124,2,98,0],[125,0,98,1],[125,3]],"functionMap":{"names":["<global>","Im2ColPackedProgram","Im2ColPackedProgram#constructor"],"mappings":"AAA;OCkB;ICC;KD6E;CDC"},"hasCjsExports":false},"type":"js/module"}]}