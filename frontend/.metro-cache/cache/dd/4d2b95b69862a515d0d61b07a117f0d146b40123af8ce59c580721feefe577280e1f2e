{"dependencies":[{"name":"./shader_compiler","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":17,"column":0,"index":682},"end":{"line":17,"column":54,"index":736}}],"key":"yVSKlvZSxQn3Ck2puzGVWEYPzq8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"ScatterPackedProgram\", {\n    enumerable: true,\n    get: function () {\n      return ScatterPackedProgram;\n    }\n  });\n  var _shader_compiler = require(_dependencyMap[0], \"./shader_compiler\");\n  /**\n   * @license\n   * Copyright 2023 Google LLC.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n\n  class ScatterPackedProgram {\n    constructor(updateSize, sliceDim, indicesRank, updatesRank, strides, shape, summingDupeIndex = true, defaultIsTensor = false) {\n      this.variableNames = ['updates', 'indices', 'defaultValue'];\n      this.packedInputs = true;\n      this.packedOutput = true;\n      this.outputShape = shape;\n      const stridesType = (0, _shader_compiler.getCoordsDataType)(strides.length);\n      const dtype = (0, _shader_compiler.getCoordsDataType)(shape.length);\n      let indicesString = '';\n      if (indicesRank === 1) {\n        indicesString = 'i';\n      } else if (indicesRank === 2) {\n        indicesString = 'i, j';\n      }\n      const indicesSnippet = `getIndices(${indicesString})`;\n      let updatesString = '';\n      if (updatesRank === 1) {\n        updatesString = 'i';\n      } else if (updatesRank === 2) {\n        updatesString = 'i, coords[1]';\n      }\n      const updatesSnippet = `getUpdates(${updatesString})`;\n      let defaultValuesString = '';\n      if (defaultIsTensor) {\n        defaultValuesString = 'coords[0], coords[1]';\n      }\n      const defaultValueSnippet = `getDefaultValue(${defaultValuesString})`;\n      const strideString = sliceDim > 1 ? 'strides[j]' : 'strides';\n      const strideString2 = sliceDim > 1 ? 'strides[j + 1]' : 'strides';\n      this.userCode = `\n        ${stridesType} strides = ${stridesType}(${strides});\n\n        void main() {\n          ${dtype} coords = getOutputCoords();\n          vec4 sum = vec4(0.);\n          vec4 found = vec4(0.);\n          for (int i = 0; i < ${updateSize}; i+=2) {\n            ivec2 flattenedIndex = ivec2(0);\n            for (int j = 0; j < ${sliceDim}; j+=2) {\n              ivec4 index = round(${indicesSnippet});\n              flattenedIndex += index.xz * ${strideString};\n              if (j + 1 < ${sliceDim}) {\n                flattenedIndex += index.yw * ${strideString2};\n              }\n            }\n            if (flattenedIndex[0] == coords[0] || flattenedIndex[1] == coords[0] ||\n                flattenedIndex[0] == coords[0] + 1 || flattenedIndex[1] == coords[0] + 1) {\n              vec4 updVals = ${updatesSnippet};\n              if (flattenedIndex[0] == coords[0]) {\n                sum.xy += updVals.xy;\n                found.xy = vec2(1.);\n              } else if (flattenedIndex[0] == coords[0] + 1) {\n                sum.zw += updVals.xy;\n                found.zw = vec2(1.);\n              }\n              if (flattenedIndex[1] == coords[0]) {\n                sum.xy += updVals.zw;\n                found.xy = vec2(1.);\n              } else if (flattenedIndex[1] == coords[0] + 1) {\n                sum.zw += updVals.zw;\n                found.zw = vec2(1.);\n              }\n            }\n          }\n          setOutput(mix(${defaultValueSnippet}, sum, found));\n        }\n      `;\n    }\n  }\n});","lineCount":100,"map":[[7,2,18,0,"Object"],[7,8,18,0],[7,9,18,0,"defineProperty"],[7,23,18,0],[7,24,18,0,"exports"],[7,31,18,0],[8,4,18,0,"enumerable"],[8,14,18,0],[9,4,18,0,"get"],[9,7,18,0],[9,18,18,0,"get"],[9,19,18,0],[10,6,18,0],[10,13,18,0,"ScatterPackedProgram"],[10,33,18,0],[11,4,18,0],[12,2,18,0],[13,2,17,0],[13,6,17,0,"_shader_compiler"],[13,22,17,0],[13,25,17,0,"require"],[13,32,17,0],[13,33,17,0,"_dependencyMap"],[13,47,17,0],[14,2,1,0],[15,0,2,0],[16,0,3,0],[17,0,4,0],[18,0,5,0],[19,0,6,0],[20,0,7,0],[21,0,8,0],[22,0,9,0],[23,0,10,0],[24,0,11,0],[25,0,12,0],[26,0,13,0],[27,0,14,0],[28,0,15,0],[29,0,16,0],[31,2,18,7],[31,8,18,13,"ScatterPackedProgram"],[31,28,18,33],[31,29,18,34],[32,4,19,4,"constructor"],[32,15,19,15,"constructor"],[32,16,19,16,"updateSize"],[32,26,19,26],[32,28,19,28,"sliceDim"],[32,36,19,36],[32,38,19,38,"indicesRank"],[32,49,19,49],[32,51,19,51,"updatesRank"],[32,62,19,62],[32,64,19,64,"strides"],[32,71,19,71],[32,73,19,73,"shape"],[32,78,19,78],[32,80,19,80,"summingDupeIndex"],[32,96,19,96],[32,99,19,99],[32,103,19,103],[32,105,19,105,"defaultIsTensor"],[32,120,19,120],[32,123,19,123],[32,128,19,128],[32,130,19,130],[33,6,20,8],[33,10,20,12],[33,11,20,13,"variableNames"],[33,24,20,26],[33,27,20,29],[33,28,20,30],[33,37,20,39],[33,39,20,41],[33,48,20,50],[33,50,20,52],[33,64,20,66],[33,65,20,67],[34,6,21,8],[34,10,21,12],[34,11,21,13,"packedInputs"],[34,23,21,25],[34,26,21,28],[34,30,21,32],[35,6,22,8],[35,10,22,12],[35,11,22,13,"packedOutput"],[35,23,22,25],[35,26,22,28],[35,30,22,32],[36,6,23,8],[36,10,23,12],[36,11,23,13,"outputShape"],[36,22,23,24],[36,25,23,27,"shape"],[36,30,23,32],[37,6,24,8],[37,12,24,14,"stridesType"],[37,23,24,25],[37,26,24,28],[37,30,24,28,"getCoordsDataType"],[37,46,24,45],[37,47,24,45,"getCoordsDataType"],[37,64,24,45],[37,66,24,46,"strides"],[37,73,24,53],[37,74,24,54,"length"],[37,80,24,60],[37,81,24,61],[38,6,25,8],[38,12,25,14,"dtype"],[38,17,25,19],[38,20,25,22],[38,24,25,22,"getCoordsDataType"],[38,40,25,39],[38,41,25,39,"getCoordsDataType"],[38,58,25,39],[38,60,25,40,"shape"],[38,65,25,45],[38,66,25,46,"length"],[38,72,25,52],[38,73,25,53],[39,6,26,8],[39,10,26,12,"indicesString"],[39,23,26,25],[39,26,26,28],[39,28,26,30],[40,6,27,8],[40,10,27,12,"indicesRank"],[40,21,27,23],[40,26,27,28],[40,27,27,29],[40,29,27,31],[41,8,28,12,"indicesString"],[41,21,28,25],[41,24,28,28],[41,27,28,31],[42,6,29,8],[42,7,29,9],[42,13,30,13],[42,17,30,17,"indicesRank"],[42,28,30,28],[42,33,30,33],[42,34,30,34],[42,36,30,36],[43,8,31,12,"indicesString"],[43,21,31,25],[43,24,31,28],[43,30,31,34],[44,6,32,8],[45,6,33,8],[45,12,33,14,"indicesSnippet"],[45,26,33,28],[45,29,33,31],[45,43,33,45,"indicesString"],[45,56,33,58],[45,59,33,61],[46,6,34,8],[46,10,34,12,"updatesString"],[46,23,34,25],[46,26,34,28],[46,28,34,30],[47,6,35,8],[47,10,35,12,"updatesRank"],[47,21,35,23],[47,26,35,28],[47,27,35,29],[47,29,35,31],[48,8,36,12,"updatesString"],[48,21,36,25],[48,24,36,28],[48,27,36,31],[49,6,37,8],[49,7,37,9],[49,13,38,13],[49,17,38,17,"updatesRank"],[49,28,38,28],[49,33,38,33],[49,34,38,34],[49,36,38,36],[50,8,39,12,"updatesString"],[50,21,39,25],[50,24,39,28],[50,38,39,42],[51,6,40,8],[52,6,41,8],[52,12,41,14,"updatesSnippet"],[52,26,41,28],[52,29,41,31],[52,43,41,45,"updatesString"],[52,56,41,58],[52,59,41,61],[53,6,42,8],[53,10,42,12,"defaultValuesString"],[53,29,42,31],[53,32,42,34],[53,34,42,36],[54,6,43,8],[54,10,43,12,"defaultIsTensor"],[54,25,43,27],[54,27,43,29],[55,8,44,12,"defaultValuesString"],[55,27,44,31],[55,30,44,34],[55,52,44,56],[56,6,45,8],[57,6,46,8],[57,12,46,14,"defaultValueSnippet"],[57,31,46,33],[57,34,46,36],[57,53,46,55,"defaultValuesString"],[57,72,46,74],[57,75,46,77],[58,6,47,8],[58,12,47,14,"strideString"],[58,24,47,26],[58,27,47,29,"sliceDim"],[58,35,47,37],[58,38,47,40],[58,39,47,41],[58,42,47,44],[58,54,47,56],[58,57,47,59],[58,66,47,68],[59,6,48,8],[59,12,48,14,"strideString2"],[59,25,48,27],[59,28,48,30,"sliceDim"],[59,36,48,38],[59,39,48,41],[59,40,48,42],[59,43,48,45],[59,59,48,61],[59,62,48,64],[59,71,48,73],[60,6,49,8],[60,10,49,12],[60,11,49,13,"userCode"],[60,19,49,21],[60,22,49,24],[61,0,50,0],[61,10,50,10,"stridesType"],[61,21,50,21],[61,35,50,35,"stridesType"],[61,46,50,46],[61,50,50,50,"strides"],[61,57,50,57],[62,0,51,0],[63,0,52,0],[64,0,53,0],[64,12,53,12,"dtype"],[64,17,53,17],[65,0,54,0],[66,0,55,0],[67,0,56,0],[67,32,56,32,"updateSize"],[67,42,56,42],[68,0,57,0],[69,0,58,0],[69,34,58,34,"sliceDim"],[69,42,58,42],[70,0,59,0],[70,36,59,36,"indicesSnippet"],[70,50,59,50],[71,0,60,0],[71,45,60,45,"strideString"],[71,57,60,57],[72,0,61,0],[72,28,61,28,"sliceDim"],[72,36,61,36],[73,0,62,0],[73,47,62,47,"strideString2"],[73,60,62,60],[74,0,63,0],[75,0,64,0],[76,0,65,0],[77,0,66,0],[78,0,67,0],[78,31,67,31,"updatesSnippet"],[78,45,67,45],[79,0,68,0],[80,0,69,0],[81,0,70,0],[82,0,71,0],[83,0,72,0],[84,0,73,0],[85,0,74,0],[86,0,75,0],[87,0,76,0],[88,0,77,0],[89,0,78,0],[90,0,79,0],[91,0,80,0],[92,0,81,0],[93,0,82,0],[94,0,83,0],[95,0,84,0],[95,26,84,26,"defaultValueSnippet"],[95,45,84,45],[96,0,85,0],[97,0,86,0],[97,7,86,7],[98,4,87,4],[99,2,88,0],[100,0,88,1],[100,3]],"functionMap":{"names":["<global>","ScatterPackedProgram","ScatterPackedProgram#constructor"],"mappings":"AAA;OCiB;ICC;KDoE;CDC"},"hasCjsExports":false},"type":"js/module"}]}