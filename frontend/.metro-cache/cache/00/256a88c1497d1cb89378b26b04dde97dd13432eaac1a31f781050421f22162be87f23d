{"dependencies":[],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"SegmentOpProgram\", {\n    enumerable: true,\n    get: function () {\n      return SegmentOpProgram;\n    }\n  });\n  /**\n   * @license\n   * Copyright 2018 Google LLC. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n  class SegmentOpProgram {\n    constructor(segOpInfo, segOpType) {\n      this.variableNames = ['x', 'segmentIds'];\n      const windowSize = segOpInfo.windowSize;\n      const batchSize = segOpInfo.batchSize;\n      const inSize = segOpInfo.inSize;\n      const numSegments = segOpInfo.numSegments;\n      const outSize = numSegments * Math.ceil(inSize / windowSize);\n      this.outputShape = [batchSize, outSize];\n      const initializationValue = '0.0';\n      const returnValue = `sumValue`;\n      const windowSizeNearestVec4 = Math.floor(windowSize / 4) * 4;\n      const windowSizeVec4Remainder = windowSize % 4;\n      const updateSnippet = `\n        sumValue += dot(values, segFilter);\n    `;\n      let checkValueOutOfBounds = '';\n      if (inSize % windowSize > 0) {\n        checkValueOutOfBounds = `\n        if (inIdx < 0 || inIdx >= ${inSize}) {\n          return initializationValue;\n        }\n      `;\n      }\n      let checkSegmentIdOutOfBounds = '';\n      if (inSize % windowSize > 0) {\n        checkSegmentIdOutOfBounds = `\n        if (inIdx < 0 || inIdx >= ${inSize}) {\n          return -1.0;\n        }\n      `;\n      }\n      this.userCode = `\n      const float initializationValue = ${initializationValue};\n\n      float getValue(int batch, int inIdx) {\n        ${checkValueOutOfBounds}\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        ${checkSegmentIdOutOfBounds}\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          ${numSegments})) * float(${windowSize}));\n        int currentSeg = int(mod(float(outIdx), float(${numSegments})));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < ${windowSizeNearestVec4}; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          ${updateSnippet}\n        }\n\n        int inIdx = inOffset + ${windowSizeNearestVec4};\n        if (${windowSizeVec4Remainder === 1}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          ${updateSnippet}\n        } else if (${windowSizeVec4Remainder === 2}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          ${updateSnippet}\n        } else if (${windowSizeVec4Remainder === 3}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          ${updateSnippet}\n        }\n        setOutput(${returnValue});\n      }\n    `;\n    }\n  }\n});","lineCount":160,"map":[[7,2,17,0,"Object"],[7,8,17,0],[7,9,17,0,"defineProperty"],[7,23,17,0],[7,24,17,0,"exports"],[7,31,17,0],[8,4,17,0,"enumerable"],[8,14,17,0],[9,4,17,0,"get"],[9,7,17,0],[9,18,17,0,"get"],[9,19,17,0],[10,6,17,0],[10,13,17,0,"SegmentOpProgram"],[10,29,17,0],[11,4,17,0],[12,2,17,0],[13,2,1,0],[14,0,2,0],[15,0,3,0],[16,0,4,0],[17,0,5,0],[18,0,6,0],[19,0,7,0],[20,0,8,0],[21,0,9,0],[22,0,10,0],[23,0,11,0],[24,0,12,0],[25,0,13,0],[26,0,14,0],[27,0,15,0],[28,0,16,0],[29,2,17,7],[29,8,17,13,"SegmentOpProgram"],[29,24,17,29],[29,25,17,30],[30,4,18,4,"constructor"],[30,15,18,15,"constructor"],[30,16,18,16,"segOpInfo"],[30,25,18,25],[30,27,18,27,"segOpType"],[30,36,18,36],[30,38,18,38],[31,6,19,8],[31,10,19,12],[31,11,19,13,"variableNames"],[31,24,19,26],[31,27,19,29],[31,28,19,30],[31,31,19,33],[31,33,19,35],[31,45,19,47],[31,46,19,48],[32,6,20,8],[32,12,20,14,"windowSize"],[32,22,20,24],[32,25,20,27,"segOpInfo"],[32,34,20,36],[32,35,20,37,"windowSize"],[32,45,20,47],[33,6,21,8],[33,12,21,14,"batchSize"],[33,21,21,23],[33,24,21,26,"segOpInfo"],[33,33,21,35],[33,34,21,36,"batchSize"],[33,43,21,45],[34,6,22,8],[34,12,22,14,"inSize"],[34,18,22,20],[34,21,22,23,"segOpInfo"],[34,30,22,32],[34,31,22,33,"inSize"],[34,37,22,39],[35,6,23,8],[35,12,23,14,"numSegments"],[35,23,23,25],[35,26,23,28,"segOpInfo"],[35,35,23,37],[35,36,23,38,"numSegments"],[35,47,23,49],[36,6,24,8],[36,12,24,14,"outSize"],[36,19,24,21],[36,22,24,24,"numSegments"],[36,33,24,35],[36,36,24,38,"Math"],[36,40,24,42],[36,41,24,43,"ceil"],[36,45,24,47],[36,46,24,48,"inSize"],[36,52,24,54],[36,55,24,57,"windowSize"],[36,65,24,67],[36,66,24,68],[37,6,25,8],[37,10,25,12],[37,11,25,13,"outputShape"],[37,22,25,24],[37,25,25,27],[37,26,25,28,"batchSize"],[37,35,25,37],[37,37,25,39,"outSize"],[37,44,25,46],[37,45,25,47],[38,6,26,8],[38,12,26,14,"initializationValue"],[38,31,26,33],[38,34,26,36],[38,39,26,41],[39,6,27,8],[39,12,27,14,"returnValue"],[39,23,27,25],[39,26,27,28],[39,36,27,38],[40,6,28,8],[40,12,28,14,"windowSizeNearestVec4"],[40,33,28,35],[40,36,28,38,"Math"],[40,40,28,42],[40,41,28,43,"floor"],[40,46,28,48],[40,47,28,49,"windowSize"],[40,57,28,59],[40,60,28,62],[40,61,28,63],[40,62,28,64],[40,65,28,67],[40,66,28,68],[41,6,29,8],[41,12,29,14,"windowSizeVec4Remainder"],[41,35,29,37],[41,38,29,40,"windowSize"],[41,48,29,50],[41,51,29,53],[41,52,29,54],[42,6,30,8],[42,12,30,14,"updateSnippet"],[42,25,30,27],[42,28,30,30],[43,0,31,0],[44,0,32,0],[44,5,32,5],[45,6,33,8],[45,10,33,12,"checkValueOutOfBounds"],[45,31,33,33],[45,34,33,36],[45,36,33,38],[46,6,34,8],[46,10,34,12,"inSize"],[46,16,34,18],[46,19,34,21,"windowSize"],[46,29,34,31],[46,32,34,34],[46,33,34,35],[46,35,34,37],[47,8,35,12,"checkValueOutOfBounds"],[47,29,35,33],[47,32,35,36],[48,0,36,0],[48,36,36,36,"inSize"],[48,42,36,42],[49,0,37,0],[50,0,38,0],[51,0,39,0],[51,7,39,7],[52,6,40,8],[53,6,41,8],[53,10,41,12,"checkSegmentIdOutOfBounds"],[53,35,41,37],[53,38,41,40],[53,40,41,42],[54,6,42,8],[54,10,42,12,"inSize"],[54,16,42,18],[54,19,42,21,"windowSize"],[54,29,42,31],[54,32,42,34],[54,33,42,35],[54,35,42,37],[55,8,43,12,"checkSegmentIdOutOfBounds"],[55,33,43,37],[55,36,43,40],[56,0,44,0],[56,36,44,36,"inSize"],[56,42,44,42],[57,0,45,0],[58,0,46,0],[59,0,47,0],[59,7,47,7],[60,6,48,8],[61,6,49,8],[61,10,49,12],[61,11,49,13,"userCode"],[61,19,49,21],[61,22,49,24],[62,0,50,0],[62,42,50,42,"initializationValue"],[62,61,50,61],[63,0,51,0],[64,0,52,0],[65,0,53,0],[65,10,53,10,"checkValueOutOfBounds"],[65,31,53,31],[66,0,54,0],[67,0,55,0],[68,0,56,0],[69,0,57,0],[70,0,58,0],[70,10,58,10,"checkSegmentIdOutOfBounds"],[70,35,58,35],[71,0,59,0],[72,0,60,0],[73,0,61,0],[74,0,62,0],[75,0,63,0],[76,0,64,0],[77,0,65,0],[78,0,66,0],[79,0,67,0],[79,12,67,12,"numSegments"],[79,23,67,23],[79,37,67,37,"windowSize"],[79,47,67,47],[80,0,68,0],[80,56,68,56,"numSegments"],[80,67,68,67],[81,0,69,0],[82,0,70,0],[83,0,71,0],[84,0,72,0],[84,30,72,30,"windowSizeNearestVec4"],[84,51,72,51],[85,0,73,0],[86,0,74,0],[87,0,75,0],[88,0,76,0],[89,0,77,0],[90,0,78,0],[91,0,79,0],[92,0,80,0],[93,0,81,0],[94,0,82,0],[95,0,83,0],[96,0,84,0],[97,0,85,0],[98,0,86,0],[99,0,87,0],[100,0,88,0],[100,12,88,12,"updateSnippet"],[100,25,88,25],[101,0,89,0],[102,0,90,0],[103,0,91,0],[103,33,91,33,"windowSizeNearestVec4"],[103,54,91,54],[104,0,92,0],[104,14,92,14,"windowSizeVec4Remainder"],[104,37,92,37],[104,42,92,42],[104,43,92,43],[105,0,93,0],[106,0,94,0],[107,0,95,0],[108,0,96,0],[109,0,97,0],[110,0,98,0],[111,0,99,0],[112,0,100,0],[113,0,101,0],[114,0,102,0],[115,0,103,0],[116,0,104,0],[117,0,105,0],[118,0,106,0],[119,0,107,0],[120,0,108,0],[121,0,109,0],[121,12,109,12,"updateSnippet"],[121,25,109,25],[122,0,110,0],[122,21,110,21,"windowSizeVec4Remainder"],[122,44,110,44],[122,49,110,49],[122,50,110,50],[123,0,111,0],[124,0,112,0],[125,0,113,0],[126,0,114,0],[127,0,115,0],[128,0,116,0],[129,0,117,0],[130,0,118,0],[131,0,119,0],[132,0,120,0],[133,0,121,0],[134,0,122,0],[135,0,123,0],[136,0,124,0],[137,0,125,0],[137,12,125,12,"updateSnippet"],[137,25,125,25],[138,0,126,0],[138,21,126,21,"windowSizeVec4Remainder"],[138,44,126,44],[138,49,126,49],[138,50,126,50],[139,0,127,0],[140,0,128,0],[141,0,129,0],[142,0,130,0],[143,0,131,0],[144,0,132,0],[145,0,133,0],[146,0,134,0],[147,0,135,0],[148,0,136,0],[149,0,137,0],[150,0,138,0],[151,0,139,0],[152,0,140,0],[153,0,141,0],[153,12,141,12,"updateSnippet"],[153,25,141,25],[154,0,142,0],[155,0,143,0],[155,20,143,20,"returnValue"],[155,31,143,31],[156,0,144,0],[157,0,145,0],[157,5,145,5],[158,4,146,4],[159,2,147,0],[160,0,147,1],[160,3]],"functionMap":{"names":["<global>","SegmentOpProgram","SegmentOpProgram#constructor"],"mappings":"AAA;OCgB;ICC;KDgI;CDC"},"hasCjsExports":false},"type":"js/module"}]}