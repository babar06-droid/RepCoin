{"dependencies":[{"name":"../kernel_names","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":17,"column":0,"index":703},"end":{"line":17,"column":43,"index":746}}],"key":"gQVznmdGA0uoBQvR5Q4/qW+ITHg=","exportNames":["*"],"imports":1}},{"name":"../ops/axis_util","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":18,"column":0,"index":747},"end":{"line":18,"column":58,"index":805}}],"key":"ex3cQAv0FEp8n8x5277qsqM7rtE=","exportNames":["*"],"imports":1}},{"name":"../ops/reshape","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":19,"column":0,"index":806},"end":{"line":19,"column":41,"index":847}}],"key":"y6qCHUFGUly5Bq9K/sbHhy1R7kE=","exportNames":["*"],"imports":1}},{"name":"../ops/stack","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":20,"column":0,"index":848},"end":{"line":20,"column":37,"index":885}}],"key":"xM3aAoNPrdHAx8wWt+xA+j+dJZ8=","exportNames":["*"],"imports":1}},{"name":"../ops/transpose","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":21,"column":0,"index":886},"end":{"line":21,"column":45,"index":931}}],"key":"vjONNqFNBCpqM97Rsa31jpSqzY8=","exportNames":["*"],"imports":1}},{"name":"../ops/unsorted_segment_sum","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":22,"column":0,"index":932},"end":{"line":22,"column":65,"index":997}}],"key":"/p1u/xOlGg+EnxxS9YAjAH5gKeY=","exportNames":["*"],"imports":1}},{"name":"../util","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":23,"column":0,"index":998},"end":{"line":23,"column":41,"index":1039}}],"key":"DTmef1GE5grNQfsvpIzpBlINy9c=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"gatherGradConfig\", {\n    enumerable: true,\n    get: function () {\n      return gatherGradConfig;\n    }\n  });\n  var _kernel_names = require(_dependencyMap[0], \"../kernel_names\");\n  var _opsAxis_util = require(_dependencyMap[1], \"../ops/axis_util\");\n  var _opsReshape = require(_dependencyMap[2], \"../ops/reshape\");\n  var _opsStack = require(_dependencyMap[3], \"../ops/stack\");\n  var _opsTranspose = require(_dependencyMap[4], \"../ops/transpose\");\n  var _opsUnsorted_segment_sum = require(_dependencyMap[5], \"../ops/unsorted_segment_sum\");\n  var _util = require(_dependencyMap[6], \"../util\");\n  /**\n   * @license\n   * Copyright 2020 Google LLC. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n\n  const gatherGradConfig = {\n    kernelName: _kernel_names.GatherV2,\n    inputsToSave: ['x', 'indices'],\n    gradFunc: (dy, saved, attrs) => {\n      const [x, indices] = saved;\n      const {\n        axis,\n        batchDims\n      } = attrs;\n      const parsedAxis = (0, _util.parseAxisParam)(axis, x.shape)[0];\n      const derXBatch = (x, indices, dy) => {\n        return () => {\n          const paramsShape = x.shape;\n          const indicesSize = indices.size;\n          const outerShape = paramsShape.slice(0, parsedAxis);\n          const outerDims = outerShape.length;\n          const innerShape = paramsShape.slice(axis, paramsShape.length).slice(1);\n          const innerDims = innerShape.length;\n          const outerAxesIndices = arrayRange(0, outerDims);\n          const innerAxesIndices = arrayRange(outerDims + 1, outerDims + 1 + innerDims);\n          const valuesShape = arrayConcat([outerShape, [indicesSize], innerShape]);\n          const values = (0, _opsReshape.reshape)(dy, valuesShape);\n          const reshapedIndices = (0, _opsReshape.reshape)(indices, [indicesSize]);\n          const transposeDims = arrayConcat([[outerDims], outerAxesIndices, innerAxesIndices]);\n          const valuesTranspose = (0, _opsTranspose.transpose)(values, transposeDims);\n          let paramsGrad = (0, _opsUnsorted_segment_sum.unsortedSegmentSum)(valuesTranspose, reshapedIndices, x.shape[parsedAxis]);\n          const invertTransposeDims = (0, _opsAxis_util.getUndoAxesPermutation)(transposeDims);\n          paramsGrad = (0, _opsTranspose.transpose)(paramsGrad, invertTransposeDims);\n          return paramsGrad;\n        };\n      };\n      if (batchDims === 1) {\n        const batchSize = x.shape[0];\n        const xBatch = x.split(batchSize, 0);\n        const derXBatched = () => {\n          const stacked = (0, _opsStack.stack)(xBatch.map((x, i) => {\n            return derXBatch(x, indices.slice(i, 1), dy.slice(i, 1))();\n          }));\n          return stacked.reshape(x.shape);\n        };\n        return {\n          x: derXBatched,\n          indices: () => indices\n        };\n      } else {\n        return {\n          x: derXBatch(x, indices, dy),\n          indices: () => indices\n        };\n      }\n    }\n  };\n  function arrayRange(start, stop) {\n    const result = [];\n    for (let i = start; i < stop; ++i) {\n      result.push(i);\n    }\n    return result;\n  }\n  function arrayConcat(arrays) {\n    const result = [];\n    for (let i = 0; i < arrays.length; ++i) {\n      for (let j = 0; j < arrays[i].length; ++j) {\n        result.push(arrays[i][j]);\n      }\n    }\n    return result;\n  }\n});","lineCount":105,"map":[[7,2,24,0,"Object"],[7,8,24,0],[7,9,24,0,"defineProperty"],[7,23,24,0],[7,24,24,0,"exports"],[7,31,24,0],[8,4,24,0,"enumerable"],[8,14,24,0],[9,4,24,0,"get"],[9,7,24,0],[9,18,24,0,"get"],[9,19,24,0],[10,6,24,0],[10,13,24,0,"gatherGradConfig"],[10,29,24,0],[11,4,24,0],[12,2,24,0],[13,2,17,0],[13,6,17,0,"_kernel_names"],[13,19,17,0],[13,22,17,0,"require"],[13,29,17,0],[13,30,17,0,"_dependencyMap"],[13,44,17,0],[14,2,18,0],[14,6,18,0,"_opsAxis_util"],[14,19,18,0],[14,22,18,0,"require"],[14,29,18,0],[14,30,18,0,"_dependencyMap"],[14,44,18,0],[15,2,19,0],[15,6,19,0,"_opsReshape"],[15,17,19,0],[15,20,19,0,"require"],[15,27,19,0],[15,28,19,0,"_dependencyMap"],[15,42,19,0],[16,2,20,0],[16,6,20,0,"_opsStack"],[16,15,20,0],[16,18,20,0,"require"],[16,25,20,0],[16,26,20,0,"_dependencyMap"],[16,40,20,0],[17,2,21,0],[17,6,21,0,"_opsTranspose"],[17,19,21,0],[17,22,21,0,"require"],[17,29,21,0],[17,30,21,0,"_dependencyMap"],[17,44,21,0],[18,2,22,0],[18,6,22,0,"_opsUnsorted_segment_sum"],[18,30,22,0],[18,33,22,0,"require"],[18,40,22,0],[18,41,22,0,"_dependencyMap"],[18,55,22,0],[19,2,23,0],[19,6,23,0,"_util"],[19,11,23,0],[19,14,23,0,"require"],[19,21,23,0],[19,22,23,0,"_dependencyMap"],[19,36,23,0],[20,2,1,0],[21,0,2,0],[22,0,3,0],[23,0,4,0],[24,0,5,0],[25,0,6,0],[26,0,7,0],[27,0,8,0],[28,0,9,0],[29,0,10,0],[30,0,11,0],[31,0,12,0],[32,0,13,0],[33,0,14,0],[34,0,15,0],[35,0,16,0],[37,2,24,7],[37,8,24,13,"gatherGradConfig"],[37,24,24,29],[37,27,24,32],[38,4,25,4,"kernelName"],[38,14,25,14],[38,16,25,16,"GatherV2"],[38,29,25,24],[38,30,25,24,"GatherV2"],[38,38,25,24],[39,4,26,4,"inputsToSave"],[39,16,26,16],[39,18,26,18],[39,19,26,19],[39,22,26,22],[39,24,26,24],[39,33,26,33],[39,34,26,34],[40,4,27,4,"gradFunc"],[40,12,27,12],[40,14,27,14,"gradFunc"],[40,15,27,15,"dy"],[40,17,27,17],[40,19,27,19,"saved"],[40,24,27,24],[40,26,27,26,"attrs"],[40,31,27,31],[40,36,27,36],[41,6,28,8],[41,12,28,14],[41,13,28,15,"x"],[41,14,28,16],[41,16,28,18,"indices"],[41,23,28,25],[41,24,28,26],[41,27,28,29,"saved"],[41,32,28,34],[42,6,29,8],[42,12,29,14],[43,8,29,16,"axis"],[43,12,29,20],[44,8,29,22,"batchDims"],[45,6,29,32],[45,7,29,33],[45,10,29,36,"attrs"],[45,15,29,41],[46,6,30,8],[46,12,30,14,"parsedAxis"],[46,22,30,24],[46,25,30,27],[46,29,30,27,"parseAxisParam"],[46,34,30,41],[46,35,30,41,"parseAxisParam"],[46,49,30,41],[46,51,30,42,"axis"],[46,55,30,46],[46,57,30,48,"x"],[46,58,30,49],[46,59,30,50,"shape"],[46,64,30,55],[46,65,30,56],[46,66,30,57],[46,67,30,58],[46,68,30,59],[47,6,31,8],[47,12,31,14,"derXBatch"],[47,21,31,23],[47,24,31,26,"derXBatch"],[47,25,31,27,"x"],[47,26,31,28],[47,28,31,30,"indices"],[47,35,31,37],[47,37,31,39,"dy"],[47,39,31,41],[47,44,31,46],[48,8,32,12],[48,15,32,19],[48,21,32,25],[49,10,33,16],[49,16,33,22,"paramsShape"],[49,27,33,33],[49,30,33,36,"x"],[49,31,33,37],[49,32,33,38,"shape"],[49,37,33,43],[50,10,34,16],[50,16,34,22,"indicesSize"],[50,27,34,33],[50,30,34,36,"indices"],[50,37,34,43],[50,38,34,44,"size"],[50,42,34,48],[51,10,35,16],[51,16,35,22,"outerShape"],[51,26,35,32],[51,29,35,35,"paramsShape"],[51,40,35,46],[51,41,35,47,"slice"],[51,46,35,52],[51,47,35,53],[51,48,35,54],[51,50,35,56,"parsedAxis"],[51,60,35,66],[51,61,35,67],[52,10,36,16],[52,16,36,22,"outerDims"],[52,25,36,31],[52,28,36,34,"outerShape"],[52,38,36,44],[52,39,36,45,"length"],[52,45,36,51],[53,10,37,16],[53,16,37,22,"innerShape"],[53,26,37,32],[53,29,37,35,"paramsShape"],[53,40,37,46],[53,41,37,47,"slice"],[53,46,37,52],[53,47,37,53,"axis"],[53,51,37,57],[53,53,37,59,"paramsShape"],[53,64,37,70],[53,65,37,71,"length"],[53,71,37,77],[53,72,37,78],[53,73,37,79,"slice"],[53,78,37,84],[53,79,37,85],[53,80,37,86],[53,81,37,87],[54,10,38,16],[54,16,38,22,"innerDims"],[54,25,38,31],[54,28,38,34,"innerShape"],[54,38,38,44],[54,39,38,45,"length"],[54,45,38,51],[55,10,39,16],[55,16,39,22,"outerAxesIndices"],[55,32,39,38],[55,35,39,41,"arrayRange"],[55,45,39,51],[55,46,39,52],[55,47,39,53],[55,49,39,55,"outerDims"],[55,58,39,64],[55,59,39,65],[56,10,40,16],[56,16,40,22,"innerAxesIndices"],[56,32,40,38],[56,35,40,41,"arrayRange"],[56,45,40,51],[56,46,40,52,"outerDims"],[56,55,40,61],[56,58,40,64],[56,59,40,65],[56,61,40,67,"outerDims"],[56,70,40,76],[56,73,40,79],[56,74,40,80],[56,77,40,83,"innerDims"],[56,86,40,92],[56,87,40,93],[57,10,41,16],[57,16,41,22,"valuesShape"],[57,27,41,33],[57,30,41,36,"arrayConcat"],[57,41,41,47],[57,42,41,48],[57,43,41,49,"outerShape"],[57,53,41,59],[57,55,41,61],[57,56,41,62,"indicesSize"],[57,67,41,73],[57,68,41,74],[57,70,42,20,"innerShape"],[57,80,42,30],[57,81,42,31],[57,82,42,32],[58,10,43,16],[58,16,43,22,"values"],[58,22,43,28],[58,25,43,31],[58,29,43,31,"reshape"],[58,40,43,38],[58,41,43,38,"reshape"],[58,48,43,38],[58,50,43,39,"dy"],[58,52,43,41],[58,54,43,43,"valuesShape"],[58,65,43,54],[58,66,43,55],[59,10,44,16],[59,16,44,22,"reshapedIndices"],[59,31,44,37],[59,34,44,40],[59,38,44,40,"reshape"],[59,49,44,47],[59,50,44,47,"reshape"],[59,57,44,47],[59,59,44,48,"indices"],[59,66,44,55],[59,68,44,57],[59,69,44,58,"indicesSize"],[59,80,44,69],[59,81,44,70],[59,82,44,71],[60,10,45,16],[60,16,45,22,"transposeDims"],[60,29,45,35],[60,32,45,38,"arrayConcat"],[60,43,45,49],[60,44,45,50],[60,45,45,51],[60,46,45,52,"outerDims"],[60,55,45,61],[60,56,45,62],[60,58,45,64,"outerAxesIndices"],[60,74,45,80],[60,76,45,82,"innerAxesIndices"],[60,92,45,98],[60,93,45,99],[60,94,45,100],[61,10,46,16],[61,16,46,22,"valuesTranspose"],[61,31,46,37],[61,34,46,40],[61,38,46,40,"transpose"],[61,51,46,49],[61,52,46,49,"transpose"],[61,61,46,49],[61,63,46,50,"values"],[61,69,46,56],[61,71,46,58,"transposeDims"],[61,84,46,71],[61,85,46,72],[62,10,47,16],[62,14,47,20,"paramsGrad"],[62,24,47,30],[62,27,47,33],[62,31,47,33,"unsortedSegmentSum"],[62,55,47,51],[62,56,47,51,"unsortedSegmentSum"],[62,74,47,51],[62,76,47,52,"valuesTranspose"],[62,91,47,67],[62,93,47,69,"reshapedIndices"],[62,108,47,84],[62,110,47,86,"x"],[62,111,47,87],[62,112,47,88,"shape"],[62,117,47,93],[62,118,47,94,"parsedAxis"],[62,128,47,104],[62,129,47,105],[62,130,47,106],[63,10,48,16],[63,16,48,22,"invertTransposeDims"],[63,35,48,41],[63,38,48,44],[63,42,48,44,"getUndoAxesPermutation"],[63,55,48,66],[63,56,48,66,"getUndoAxesPermutation"],[63,78,48,66],[63,80,48,67,"transposeDims"],[63,93,48,80],[63,94,48,81],[64,10,49,16,"paramsGrad"],[64,20,49,26],[64,23,49,29],[64,27,49,29,"transpose"],[64,40,49,38],[64,41,49,38,"transpose"],[64,50,49,38],[64,52,49,39,"paramsGrad"],[64,62,49,49],[64,64,49,51,"invertTransposeDims"],[64,83,49,70],[64,84,49,71],[65,10,50,16],[65,17,50,23,"paramsGrad"],[65,27,50,33],[66,8,51,12],[66,9,51,13],[67,6,52,8],[67,7,52,9],[68,6,53,8],[68,10,53,12,"batchDims"],[68,19,53,21],[68,24,53,26],[68,25,53,27],[68,27,53,29],[69,8,54,12],[69,14,54,18,"batchSize"],[69,23,54,27],[69,26,54,30,"x"],[69,27,54,31],[69,28,54,32,"shape"],[69,33,54,37],[69,34,54,38],[69,35,54,39],[69,36,54,40],[70,8,55,12],[70,14,55,18,"xBatch"],[70,20,55,24],[70,23,55,27,"x"],[70,24,55,28],[70,25,55,29,"split"],[70,30,55,34],[70,31,55,35,"batchSize"],[70,40,55,44],[70,42,55,46],[70,43,55,47],[70,44,55,48],[71,8,56,12],[71,14,56,18,"derXBatched"],[71,25,56,29],[71,28,56,32,"derXBatched"],[71,29,56,32],[71,34,56,38],[72,10,57,16],[72,16,57,22,"stacked"],[72,23,57,29],[72,26,57,32],[72,30,57,32,"stack"],[72,39,57,37],[72,40,57,37,"stack"],[72,45,57,37],[72,47,57,38,"xBatch"],[72,53,57,44],[72,54,57,45,"map"],[72,57,57,48],[72,58,57,49],[72,59,57,50,"x"],[72,60,57,51],[72,62,57,53,"i"],[72,63,57,54],[72,68,57,59],[73,12,58,20],[73,19,58,27,"derXBatch"],[73,28,58,36],[73,29,58,37,"x"],[73,30,58,38],[73,32,58,40,"indices"],[73,39,58,47],[73,40,58,48,"slice"],[73,45,58,53],[73,46,58,54,"i"],[73,47,58,55],[73,49,58,57],[73,50,58,58],[73,51,58,59],[73,53,58,61,"dy"],[73,55,58,63],[73,56,58,64,"slice"],[73,61,58,69],[73,62,58,70,"i"],[73,63,58,71],[73,65,58,73],[73,66,58,74],[73,67,58,75],[73,68,58,76],[73,69,58,77],[73,70,58,78],[74,10,59,16],[74,11,59,17],[74,12,59,18],[74,13,59,19],[75,10,60,16],[75,17,60,23,"stacked"],[75,24,60,30],[75,25,60,31,"reshape"],[75,32,60,38],[75,33,60,39,"x"],[75,34,60,40],[75,35,60,41,"shape"],[75,40,60,46],[75,41,60,47],[76,8,61,12],[76,9,61,13],[77,8,62,12],[77,15,62,19],[78,10,62,21,"x"],[78,11,62,22],[78,13,62,24,"derXBatched"],[78,24,62,35],[79,10,62,37,"indices"],[79,17,62,44],[79,19,62,46,"indices"],[79,20,62,46],[79,25,62,52,"indices"],[80,8,62,60],[80,9,62,61],[81,6,63,8],[81,7,63,9],[81,13,64,13],[82,8,65,12],[82,15,65,19],[83,10,65,21,"x"],[83,11,65,22],[83,13,65,24,"derXBatch"],[83,22,65,33],[83,23,65,34,"x"],[83,24,65,35],[83,26,65,37,"indices"],[83,33,65,44],[83,35,65,46,"dy"],[83,37,65,48],[83,38,65,49],[84,10,65,51,"indices"],[84,17,65,58],[84,19,65,60,"indices"],[84,20,65,60],[84,25,65,66,"indices"],[85,8,65,74],[85,9,65,75],[86,6,66,8],[87,4,67,4],[88,2,68,0],[88,3,68,1],[89,2,69,0],[89,11,69,9,"arrayRange"],[89,21,69,19,"arrayRange"],[89,22,69,20,"start"],[89,27,69,25],[89,29,69,27,"stop"],[89,33,69,31],[89,35,69,33],[90,4,70,4],[90,10,70,10,"result"],[90,16,70,16],[90,19,70,19],[90,21,70,21],[91,4,71,4],[91,9,71,9],[91,13,71,13,"i"],[91,14,71,14],[91,17,71,17,"start"],[91,22,71,22],[91,24,71,24,"i"],[91,25,71,25],[91,28,71,28,"stop"],[91,32,71,32],[91,34,71,34],[91,36,71,36,"i"],[91,37,71,37],[91,39,71,39],[92,6,72,8,"result"],[92,12,72,14],[92,13,72,15,"push"],[92,17,72,19],[92,18,72,20,"i"],[92,19,72,21],[92,20,72,22],[93,4,73,4],[94,4,74,4],[94,11,74,11,"result"],[94,17,74,17],[95,2,75,0],[96,2,76,0],[96,11,76,9,"arrayConcat"],[96,22,76,20,"arrayConcat"],[96,23,76,21,"arrays"],[96,29,76,27],[96,31,76,29],[97,4,77,4],[97,10,77,10,"result"],[97,16,77,16],[97,19,77,19],[97,21,77,21],[98,4,78,4],[98,9,78,9],[98,13,78,13,"i"],[98,14,78,14],[98,17,78,17],[98,18,78,18],[98,20,78,20,"i"],[98,21,78,21],[98,24,78,24,"arrays"],[98,30,78,30],[98,31,78,31,"length"],[98,37,78,37],[98,39,78,39],[98,41,78,41,"i"],[98,42,78,42],[98,44,78,44],[99,6,79,8],[99,11,79,13],[99,15,79,17,"j"],[99,16,79,18],[99,19,79,21],[99,20,79,22],[99,22,79,24,"j"],[99,23,79,25],[99,26,79,28,"arrays"],[99,32,79,34],[99,33,79,35,"i"],[99,34,79,36],[99,35,79,37],[99,36,79,38,"length"],[99,42,79,44],[99,44,79,46],[99,46,79,48,"j"],[99,47,79,49],[99,49,79,51],[100,8,80,12,"result"],[100,14,80,18],[100,15,80,19,"push"],[100,19,80,23],[100,20,80,24,"arrays"],[100,26,80,30],[100,27,80,31,"i"],[100,28,80,32],[100,29,80,33],[100,30,80,34,"j"],[100,31,80,35],[100,32,80,36],[100,33,80,37],[101,6,81,8],[102,4,82,4],[103,4,83,4],[103,11,83,11,"result"],[103,17,83,17],[104,2,84,0],[105,0,84,1],[105,3]],"functionMap":{"names":["<global>","gatherGradConfig.gradFunc","derXBatch","<anonymous>","derXBatched","xBatch.map$argument_0","indices","arrayRange","arrayConcat"],"mappings":"AAA;cC0B;0BCI;mBCC;aDmB;SDC;gCGI;iDCC;iBDE;aHE;8CKC,aL;4DKG,aL;KDE;AOE;CPM;AQC;CRQ"},"hasCjsExports":false},"type":"js/module"}]}