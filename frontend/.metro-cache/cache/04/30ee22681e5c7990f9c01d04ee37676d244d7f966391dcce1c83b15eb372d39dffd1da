{"dependencies":[{"name":"../base","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":17,"column":0,"index":703},"end":{"line":17,"column":39,"index":742}}],"key":"YmDmZxr+JPUF33I3pg2GQyiGAhM=","exportNames":["*"],"imports":1}},{"name":"../kernel_names","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":18,"column":0,"index":743},"end":{"line":18,"column":39,"index":782}}],"key":"gQVznmdGA0uoBQvR5Q4/qW+ITHg=","exportNames":["*"],"imports":1}},{"name":"../ops/cumprod","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":19,"column":0,"index":783},"end":{"line":19,"column":41,"index":824}}],"key":"iSQNaye9DxKaamsckbwaQJQkeRc=","exportNames":["*"],"imports":1}},{"name":"../ops/mul","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":20,"column":0,"index":825},"end":{"line":20,"column":33,"index":858}}],"key":"8VMM/o0r3nOvGtT2jgKf2KxknFk=","exportNames":["*"],"imports":1}},{"name":"../ops/reshape","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":21,"column":0,"index":859},"end":{"line":21,"column":41,"index":900}}],"key":"y6qCHUFGUly5Bq9K/sbHhy1R7kE=","exportNames":["*"],"imports":1}},{"name":"../ops/transpose","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":22,"column":0,"index":901},"end":{"line":22,"column":45,"index":946}}],"key":"vjONNqFNBCpqM97Rsa31jpSqzY8=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"prodGradConfig\", {\n    enumerable: true,\n    get: function () {\n      return prodGradConfig;\n    }\n  });\n  var _base = require(_dependencyMap[0], \"../base\");\n  var _kernel_names = require(_dependencyMap[1], \"../kernel_names\");\n  var _opsCumprod = require(_dependencyMap[2], \"../ops/cumprod\");\n  var _opsMul = require(_dependencyMap[3], \"../ops/mul\");\n  var _opsReshape = require(_dependencyMap[4], \"../ops/reshape\");\n  var _opsTranspose = require(_dependencyMap[5], \"../ops/transpose\");\n  /**\n   * @license\n   * Copyright 2022 Google Inc. All Rights Reserved.\n   * Licensed under the Apache License, Version 2.0 (the \"License\");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   * http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an \"AS IS\" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   * =============================================================================\n   */\n\n  // Gradient for product operation on a single axis.\n  function prodGradFn_(x, dy, axis) {\n    // The gradient tensor (dy) has a set of axes removed, so we create re-shaped\n    // versions (of size 1) for the removed axis; this supports broadcasting over\n    // those dimensions.\n    const expandedYShape = x.shape.slice();\n    expandedYShape[axis] = 1;\n    // The actual gradient computation.\n    const expandedDy = (0, _opsReshape.reshape)(dy, expandedYShape);\n    const xCumProd = (0, _opsCumprod.cumprod)(x, axis, true, false);\n    const xCumRevProd = (0, _opsCumprod.cumprod)(x, axis, true, true);\n    const dx = (0, _opsMul.mul)(xCumProd, xCumRevProd);\n    return (0, _opsMul.mul)(expandedDy, dx);\n  }\n  // Support gradients when the product is done on many axes at once.\n  // This done py pushing all the axes on which the product is applied into a\n  // single axis.\n  function prodsGradFn_(x, dy, axis) {\n    // Move all axes for doing prod over to the end of the tensor.\n    const xRank = x.shape.length;\n    const finalProdAxis = xRank - axis.length;\n    const xPermutation = _base.backend_util.getAxesPermutation(axis, xRank);\n    let permutedX = x;\n    if (xPermutation != null) {\n      permutedX = (0, _opsTranspose.transpose)(x, xPermutation);\n    }\n    // Reshape all the prod dimensions into a single one, and do compute prod\n    // gradients on that.\n    const newShape = permutedX.shape.slice();\n    const removedShape = newShape.splice(xRank - axis.length, axis.length);\n    const endPartShape = removedShape.reduce((p, c) => p * c, 1);\n    newShape.push(endPartShape);\n    const reshapedPermutedX = permutedX.reshape(newShape);\n    let prodGrad = prodGradFn_(reshapedPermutedX, dy, finalProdAxis);\n    // Undo the re-shaping now we have the dx vector, and permute back to\n    // original axes order.\n    prodGrad = prodGrad.reshape(permutedX.shape);\n    if (xPermutation != null) {\n      const undoPermutation = _base.backend_util.getUndoAxesPermutation(xPermutation);\n      prodGrad = (0, _opsTranspose.transpose)(prodGrad, undoPermutation);\n    }\n    return prodGrad;\n  }\n  // Running example:\n  // [\n  //   [\n  //     [3.0, 4.0],\n  //     [5.0, 6.0],\n  //     [7.0, 8.0]\n  //   ],\n  //   [\n  //     [3.0, 5.0],\n  //     [0.0, 6.0],\n  //     [5.0, 6.0]\n  //   ]\n  // ]\n  //\n  const prodGradConfig = {\n    kernelName: _kernel_names.Prod,\n    inputsToSave: ['x'],\n    gradFunc: (dy, saved, attrs) => {\n      const [x] = saved;\n      const {\n        axis\n      } = attrs;\n      let axisArr = [];\n      if (axis === undefined || axis === null) {\n        axisArr = x.shape.map((_, i) => i);\n      } else if (typeof axis === 'number') {\n        axisArr = [axis];\n      } else {\n        axisArr = axis;\n      }\n      return {\n        x: () => prodsGradFn_(x, dy, axisArr)\n      };\n    }\n  };\n});","lineCount":114,"map":[[7,2,80,0,"Object"],[7,8,80,0],[7,9,80,0,"defineProperty"],[7,23,80,0],[7,24,80,0,"exports"],[7,31,80,0],[8,4,80,0,"enumerable"],[8,14,80,0],[9,4,80,0,"get"],[9,7,80,0],[9,18,80,0,"get"],[9,19,80,0],[10,6,80,0],[10,13,80,0,"prodGradConfig"],[10,27,80,0],[11,4,80,0],[12,2,80,0],[13,2,17,0],[13,6,17,0,"_base"],[13,11,17,0],[13,14,17,0,"require"],[13,21,17,0],[13,22,17,0,"_dependencyMap"],[13,36,17,0],[14,2,18,0],[14,6,18,0,"_kernel_names"],[14,19,18,0],[14,22,18,0,"require"],[14,29,18,0],[14,30,18,0,"_dependencyMap"],[14,44,18,0],[15,2,19,0],[15,6,19,0,"_opsCumprod"],[15,17,19,0],[15,20,19,0,"require"],[15,27,19,0],[15,28,19,0,"_dependencyMap"],[15,42,19,0],[16,2,20,0],[16,6,20,0,"_opsMul"],[16,13,20,0],[16,16,20,0,"require"],[16,23,20,0],[16,24,20,0,"_dependencyMap"],[16,38,20,0],[17,2,21,0],[17,6,21,0,"_opsReshape"],[17,17,21,0],[17,20,21,0,"require"],[17,27,21,0],[17,28,21,0,"_dependencyMap"],[17,42,21,0],[18,2,22,0],[18,6,22,0,"_opsTranspose"],[18,19,22,0],[18,22,22,0,"require"],[18,29,22,0],[18,30,22,0,"_dependencyMap"],[18,44,22,0],[19,2,1,0],[20,0,2,0],[21,0,3,0],[22,0,4,0],[23,0,5,0],[24,0,6,0],[25,0,7,0],[26,0,8,0],[27,0,9,0],[28,0,10,0],[29,0,11,0],[30,0,12,0],[31,0,13,0],[32,0,14,0],[33,0,15,0],[34,0,16,0],[36,2,23,0],[37,2,24,0],[37,11,24,9,"prodGradFn_"],[37,22,24,20,"prodGradFn_"],[37,23,24,21,"x"],[37,24,24,22],[37,26,24,24,"dy"],[37,28,24,26],[37,30,24,28,"axis"],[37,34,24,32],[37,36,24,34],[38,4,25,4],[39,4,26,4],[40,4,27,4],[41,4,28,4],[41,10,28,10,"expandedYShape"],[41,24,28,24],[41,27,28,27,"x"],[41,28,28,28],[41,29,28,29,"shape"],[41,34,28,34],[41,35,28,35,"slice"],[41,40,28,40],[41,41,28,41],[41,42,28,42],[42,4,29,4,"expandedYShape"],[42,18,29,18],[42,19,29,19,"axis"],[42,23,29,23],[42,24,29,24],[42,27,29,27],[42,28,29,28],[43,4,30,4],[44,4,31,4],[44,10,31,10,"expandedDy"],[44,20,31,20],[44,23,31,23],[44,27,31,23,"reshape"],[44,38,31,30],[44,39,31,30,"reshape"],[44,46,31,30],[44,48,31,31,"dy"],[44,50,31,33],[44,52,31,35,"expandedYShape"],[44,66,31,49],[44,67,31,50],[45,4,32,4],[45,10,32,10,"xCumProd"],[45,18,32,18],[45,21,32,21],[45,25,32,21,"cumprod"],[45,36,32,28],[45,37,32,28,"cumprod"],[45,44,32,28],[45,46,32,29,"x"],[45,47,32,30],[45,49,32,32,"axis"],[45,53,32,36],[45,55,32,38],[45,59,32,42],[45,61,32,44],[45,66,32,49],[45,67,32,50],[46,4,33,4],[46,10,33,10,"xCumRevProd"],[46,21,33,21],[46,24,33,24],[46,28,33,24,"cumprod"],[46,39,33,31],[46,40,33,31,"cumprod"],[46,47,33,31],[46,49,33,32,"x"],[46,50,33,33],[46,52,33,35,"axis"],[46,56,33,39],[46,58,33,41],[46,62,33,45],[46,64,33,47],[46,68,33,51],[46,69,33,52],[47,4,34,4],[47,10,34,10,"dx"],[47,12,34,12],[47,15,34,15],[47,19,34,15,"mul"],[47,26,34,18],[47,27,34,18,"mul"],[47,30,34,18],[47,32,34,19,"xCumProd"],[47,40,34,27],[47,42,34,29,"xCumRevProd"],[47,53,34,40],[47,54,34,41],[48,4,35,4],[48,11,35,11],[48,15,35,11,"mul"],[48,22,35,14],[48,23,35,14,"mul"],[48,26,35,14],[48,28,35,15,"expandedDy"],[48,38,35,25],[48,40,35,27,"dx"],[48,42,35,29],[48,43,35,30],[49,2,36,0],[50,2,37,0],[51,2,38,0],[52,2,39,0],[53,2,40,0],[53,11,40,9,"prodsGradFn_"],[53,23,40,21,"prodsGradFn_"],[53,24,40,22,"x"],[53,25,40,23],[53,27,40,25,"dy"],[53,29,40,27],[53,31,40,29,"axis"],[53,35,40,33],[53,37,40,35],[54,4,41,4],[55,4,42,4],[55,10,42,10,"xRank"],[55,15,42,15],[55,18,42,18,"x"],[55,19,42,19],[55,20,42,20,"shape"],[55,25,42,25],[55,26,42,26,"length"],[55,32,42,32],[56,4,43,4],[56,10,43,10,"finalProdAxis"],[56,23,43,23],[56,26,43,26,"xRank"],[56,31,43,31],[56,34,43,34,"axis"],[56,38,43,38],[56,39,43,39,"length"],[56,45,43,45],[57,4,44,4],[57,10,44,10,"xPermutation"],[57,22,44,22],[57,25,44,25,"backend_util"],[57,30,44,37],[57,31,44,37,"backend_util"],[57,43,44,37],[57,44,44,38,"getAxesPermutation"],[57,62,44,56],[57,63,44,57,"axis"],[57,67,44,61],[57,69,44,63,"xRank"],[57,74,44,68],[57,75,44,69],[58,4,45,4],[58,8,45,8,"permutedX"],[58,17,45,17],[58,20,45,20,"x"],[58,21,45,21],[59,4,46,4],[59,8,46,8,"xPermutation"],[59,20,46,20],[59,24,46,24],[59,28,46,28],[59,30,46,30],[60,6,47,8,"permutedX"],[60,15,47,17],[60,18,47,20],[60,22,47,20,"transpose"],[60,35,47,29],[60,36,47,29,"transpose"],[60,45,47,29],[60,47,47,30,"x"],[60,48,47,31],[60,50,47,33,"xPermutation"],[60,62,47,45],[60,63,47,46],[61,4,48,4],[62,4,49,4],[63,4,50,4],[64,4,51,4],[64,10,51,10,"newShape"],[64,18,51,18],[64,21,51,21,"permutedX"],[64,30,51,30],[64,31,51,31,"shape"],[64,36,51,36],[64,37,51,37,"slice"],[64,42,51,42],[64,43,51,43],[64,44,51,44],[65,4,52,4],[65,10,52,10,"removedShape"],[65,22,52,22],[65,25,52,25,"newShape"],[65,33,52,33],[65,34,52,34,"splice"],[65,40,52,40],[65,41,52,41,"xRank"],[65,46,52,46],[65,49,52,49,"axis"],[65,53,52,53],[65,54,52,54,"length"],[65,60,52,60],[65,62,52,62,"axis"],[65,66,52,66],[65,67,52,67,"length"],[65,73,52,73],[65,74,52,74],[66,4,53,4],[66,10,53,10,"endPartShape"],[66,22,53,22],[66,25,53,25,"removedShape"],[66,37,53,37],[66,38,53,38,"reduce"],[66,44,53,44],[66,45,53,45],[66,46,53,46,"p"],[66,47,53,47],[66,49,53,49,"c"],[66,50,53,50],[66,55,53,55,"p"],[66,56,53,56],[66,59,53,59,"c"],[66,60,53,60],[66,62,53,62],[66,63,53,63],[66,64,53,64],[67,4,54,4,"newShape"],[67,12,54,12],[67,13,54,13,"push"],[67,17,54,17],[67,18,54,18,"endPartShape"],[67,30,54,30],[67,31,54,31],[68,4,55,4],[68,10,55,10,"reshapedPermutedX"],[68,27,55,27],[68,30,55,30,"permutedX"],[68,39,55,39],[68,40,55,40,"reshape"],[68,47,55,47],[68,48,55,48,"newShape"],[68,56,55,56],[68,57,55,57],[69,4,56,4],[69,8,56,8,"prodGrad"],[69,16,56,16],[69,19,56,19,"prodGradFn_"],[69,30,56,30],[69,31,56,31,"reshapedPermutedX"],[69,48,56,48],[69,50,56,50,"dy"],[69,52,56,52],[69,54,56,54,"finalProdAxis"],[69,67,56,67],[69,68,56,68],[70,4,57,4],[71,4,58,4],[72,4,59,4,"prodGrad"],[72,12,59,12],[72,15,59,15,"prodGrad"],[72,23,59,23],[72,24,59,24,"reshape"],[72,31,59,31],[72,32,59,32,"permutedX"],[72,41,59,41],[72,42,59,42,"shape"],[72,47,59,47],[72,48,59,48],[73,4,60,4],[73,8,60,8,"xPermutation"],[73,20,60,20],[73,24,60,24],[73,28,60,28],[73,30,60,30],[74,6,61,8],[74,12,61,14,"undoPermutation"],[74,27,61,29],[74,30,61,32,"backend_util"],[74,35,61,44],[74,36,61,44,"backend_util"],[74,48,61,44],[74,49,61,45,"getUndoAxesPermutation"],[74,71,61,67],[74,72,61,68,"xPermutation"],[74,84,61,80],[74,85,61,81],[75,6,62,8,"prodGrad"],[75,14,62,16],[75,17,62,19],[75,21,62,19,"transpose"],[75,34,62,28],[75,35,62,28,"transpose"],[75,44,62,28],[75,46,62,29,"prodGrad"],[75,54,62,37],[75,56,62,39,"undoPermutation"],[75,71,62,54],[75,72,62,55],[76,4,63,4],[77,4,64,4],[77,11,64,11,"prodGrad"],[77,19,64,19],[78,2,65,0],[79,2,66,0],[80,2,67,0],[81,2,68,0],[82,2,69,0],[83,2,70,0],[84,2,71,0],[85,2,72,0],[86,2,73,0],[87,2,74,0],[88,2,75,0],[89,2,76,0],[90,2,77,0],[91,2,78,0],[92,2,79,0],[93,2,80,7],[93,8,80,13,"prodGradConfig"],[93,22,80,27],[93,25,80,30],[94,4,81,4,"kernelName"],[94,14,81,14],[94,16,81,16,"Prod"],[94,29,81,20],[94,30,81,20,"Prod"],[94,34,81,20],[95,4,82,4,"inputsToSave"],[95,16,82,16],[95,18,82,18],[95,19,82,19],[95,22,82,22],[95,23,82,23],[96,4,83,4,"gradFunc"],[96,12,83,12],[96,14,83,14,"gradFunc"],[96,15,83,15,"dy"],[96,17,83,17],[96,19,83,19,"saved"],[96,24,83,24],[96,26,83,26,"attrs"],[96,31,83,31],[96,36,83,36],[97,6,84,8],[97,12,84,14],[97,13,84,15,"x"],[97,14,84,16],[97,15,84,17],[97,18,84,20,"saved"],[97,23,84,25],[98,6,85,8],[98,12,85,14],[99,8,85,16,"axis"],[100,6,85,21],[100,7,85,22],[100,10,85,25,"attrs"],[100,15,85,30],[101,6,86,8],[101,10,86,12,"axisArr"],[101,17,86,19],[101,20,86,22],[101,22,86,24],[102,6,87,8],[102,10,87,12,"axis"],[102,14,87,16],[102,19,87,21,"undefined"],[102,28,87,30],[102,32,87,34,"axis"],[102,36,87,38],[102,41,87,43],[102,45,87,47],[102,47,87,49],[103,8,88,12,"axisArr"],[103,15,88,19],[103,18,88,22,"x"],[103,19,88,23],[103,20,88,24,"shape"],[103,25,88,29],[103,26,88,30,"map"],[103,29,88,33],[103,30,88,34],[103,31,88,35,"_"],[103,32,88,36],[103,34,88,38,"i"],[103,35,88,39],[103,40,88,44,"i"],[103,41,88,45],[103,42,88,46],[104,6,89,8],[104,7,89,9],[104,13,90,13],[104,17,90,17],[104,24,90,24,"axis"],[104,28,90,28],[104,33,90,33],[104,41,90,41],[104,43,90,43],[105,8,91,12,"axisArr"],[105,15,91,19],[105,18,91,22],[105,19,91,23,"axis"],[105,23,91,27],[105,24,91,28],[106,6,92,8],[106,7,92,9],[106,13,93,13],[107,8,94,12,"axisArr"],[107,15,94,19],[107,18,94,22,"axis"],[107,22,94,26],[108,6,95,8],[109,6,96,8],[109,13,96,15],[110,8,96,17,"x"],[110,9,96,18],[110,11,96,20,"x"],[110,12,96,20],[110,17,96,26,"prodsGradFn_"],[110,29,96,38],[110,30,96,39,"x"],[110,31,96,40],[110,33,96,42,"dy"],[110,35,96,44],[110,37,96,46,"axisArr"],[110,44,96,53],[111,6,96,55],[111,7,96,56],[112,4,97,4],[113,2,98,0],[113,3,98,1],[114,0,98,2],[114,3]],"functionMap":{"names":["<global>","prodGradFn_","prodsGradFn_","removedShape.reduce$argument_0","prodGradConfig.gradFunc","x.shape.map$argument_0","x"],"mappings":"AAA;ACuB;CDY;AEI;6CCa,eD;CFY;cIkB;kCCK,WD;oBEQ,kCF;KJC"},"hasCjsExports":false},"type":"js/module"}]}